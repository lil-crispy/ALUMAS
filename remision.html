<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remisi√≥n ALUMAS</title>
  <link rel="icon" type="image/svg+xml" href="./img/LOGO3.webp" />

  <!-- Estilos personalizados -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fff;
      margin: 0;
      padding: 20px;
    }

    .contenedor-principal {
      width: 90%;
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }

    .encabezado .titulo {
      font-family: 'Bauhaus', sans-serif;
      font-size: 2.5em;
      font-weight: bold;
      line-height: 1;
    }

    .encabezado .subtitulo {
      font-family: 'Bauhaus', sans-serif;
      font-size: 2em;
      line-height: 1;
    }

    .info {
      text-align: left;
      margin-top: 10px;
    }

    .editable-linea {
      border-bottom: 1px solid #000;
      padding: 2px 5px;
      min-width: 200px;
      display: inline-block;
      text-transform: uppercase;
    }

    .contenedor-tabla {
      margin-top: 20px;
      overflow-x: auto;
    }

    .acciones-tabla {
      text-align: right;
      margin-bottom: 5px;
    }

    .acciones-tabla button {
      margin-left: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
      word-wrap: break-word;
      text-transform: uppercase;
    }

    td[contenteditable="true"] {
      direction: ltr;
      text-align: left;
    }

    .col-cant {
      width: 5%;
      text-align: left;
      direction: ltr;
    }

    .col-desc {
      width: 40%;
      text-align: left;
    }

    .col-valor {
      width: 12%;
    }

    .valor-u input {
      text-align: left;
      direction: ltr;
      padding-left: 5px;
    }

    .valor-t {
      background-color: #f0f0f0;
      font-weight: bold;
    }

    .total {
      font-size: 1.5em;
      margin-top: 10px;
      text-align: center;
    }

    .logo-grande {
      width: 250px;
      max-width: 550px;
      margin: 20px auto;
      display: block;
    }

    .mensaje {
      margin-top: 10px;
      font-size: 0.9em;
      text-align: center;
      line-height: 1.1;
    }

    .mensaje p,
    .mensaje small {
      margin: 0;
      padding: 0;
    }

    .boton-imprimir {
      margin-top: 15px;
    }

    /* Responsive */
    @media screen and (max-width: 600px) {
      .encabezado .titulo {
        font-size: 1.8em;
      }
      .encabezado .subtitulo {
        font-size: 1.5em;
      }
      th, td {
        font-size: 0.8em;
        padding: 3px;
        text-transform: uppercase;
      }
      td[contenteditable="true"] {
        direction: ltr;
        text-align: left;
      }
      .acciones-tabla button {
        padding: 4px 6px;
        font-size: 0.8em;
      }
      .logo-grande {
        width: 80px;
      }
      .total {
        font-size: 1em;
      }
    }

    /* ---------- FORMATOS DE IMPRESI√ìN ---------- */

    /* Para impresi√≥n ferreter√≠a (80mm) - Por defecto */
    @page {
      size: 80mm auto;
      margin: 0;
    }

    /* Para impresi√≥n bodega (A5) */
    @page bodega {
      size: A5 portrait;
      margin: 1cm;
    }

    @media print {
      body {
        width: 80mm;
        max-width: 80mm;
        font-size: 10px;
        padding: 0;
        margin: 0 auto;
        background: white;
      }

      .contenedor-principal {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0 auto;
        text-align: left;
      }

      .encabezado .titulo {
        font-size: 1.2em;
        text-align: center;
      }

      .encabezado .subtitulo {
        font-size: 1em;
        text-align: center;
      }

      .punto-venta-container,
      .acciones-tabla,
      .acciones-tabla button,
      #dashboard-programacion,
      .modal-programacion {
        display: none !important;
      }

      /* Ocultar controles solo al imprimir */
      .boton-imprimir {
        display: none !important;
      }

      .contenedor-tabla {
        width: 100%;
        overflow: visible;
      }

      table {
        width: 96%;
        table-layout: fixed;
        font-size: 9px;
        border-collapse: collapse;
        margin: 0 auto;
        page-break-inside: auto;
      }

      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }

      tr { page-break-inside: avoid; page-break-after: auto; }
      th, td {
        padding: 2px 3px;
        font-size: 9px;
        word-break: break-word;
        border: 1px solid #000;
      }

      td[contenteditable="true"] {
        direction: ltr;
        text-align: left;
      }

      .col-cant {
        width: 10%;
      }

      .col-desc {
        width: 45%;
      }

      .col-valor {
        width: 10%;
      }

      .logo-grande {
        width: 60%;
        max-width: 60%;
        height: auto;
        display: block;
        margin: 10px auto;
      }

      .total {
        font-size: 2em;
        text-align: center;
        margin-top: 10px;
      }

      /* ---------- Estilos espec√≠ficos para formato bodega ---------- */
      /* Cuando se imprime en modo bodega, ocultamos todo y mostramos solo el template PDF */
      
      body.formato-bodega {
        page: bodega; 
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
      }

      body.formato-bodega .contenedor-principal,
      body.formato-bodega #login-overlay,
      body.formato-bodega .conn-status,
      body.formato-bodega .user-bar,
      body.formato-bodega .report-toggle,
      body.formato-bodega .panel-sugerencias,
      body.formato-bodega .report-panel {
        display: none !important;
      }

      body.formato-bodega #pdf-template {
        display: block !important;
        position: static !important;
        width: 100% !important; /* Ajustar al ancho del papel (A5) */
        margin: 0 auto !important;
        padding: 0 !important;
        box-sizing: border-box !important;
        z-index: 9999 !important;
        /* El template original es 21cm, si el papel es A5 (14.8cm), debemos escalar o dejar que fluya.
           Como el template tiene anchos fijos en px (220px, etc), con 100% width deber√≠a ajustarse 
           siempre y cuando no exceda.
           Si se ve muy grande, se puede usar zoom o transform.
        */
        zoom: 0.7; /* Escalado aproximado para que 21cm quepan en A5 (14.8cm) */
      }
      
      /* Asegurar que la tabla interna del template se vea bien */
      body.formato-bodega #pdf-template table {
         width: 100% !important;
      }
    }

    /* Correcci√≥n de direcci√≥n de escritura y cursor */
    .cant, .valor-u {
      direction: ltr;
      text-align: left;
      unicode-bidi: plaintext;
    }

    .edit-consecutivo {
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    .edit-consecutivo:hover {
      opacity: 1;
    }
    .fila-seleccionada {
      background-color: #e0f7fa !important;
      outline: 2px solid #00acc1;
    }

    /* --- ESTILOS DASHBOARD PROGRAMACI√ìN --- */
    #dashboard-programacion {
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      height: 100%;
      background: #f8f9fa;
      border-right: 2px solid #ddd;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding: 10px;
      overflow-y: auto;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    #dashboard-programacion h3 {
      font-family: 'Bauhaus', sans-serif;
      font-size: 1.2em;
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 2px solid #00acc1;
      padding-bottom: 5px;
      margin-top: 0;
    }

    .pedido-item {
      background: white;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      font-size: 0.9em;
    }

    .pedido-item:hover {
      background: #e0f7fa;
      transform: translateX(-2px);
    }

    .pedido-item.selected {
      border-color: #00acc1;
      background: #b2ebf2;
      box-shadow: 0 0 5px rgba(0,172,193,0.5);
    }

    .pedido-info {
      margin-bottom: 3px;
    }
    
    .pedido-status {
      font-weight: bold;
      color: #00acc1;
      font-size: 0.8em;
      text-transform: uppercase;
    }

    .btn-despachado {
      background: #4caf50;
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      cursor: pointer;
      margin-top: auto;
      font-weight: bold;
      border-radius: 4px;
      font-family: 'Bauhaus', sans-serif;
      font-size: 1.1em;
    }

    .btn-despachado:hover {
      background: #45a049;
    }

    /* Modal Programaci√≥n */
    .modal-programacion {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .btn-guardar-prog {
      background: #00acc1;
      color: white;
      border: none;
      padding: 8px 20px;
      cursor: pointer;
      font-size: 1em;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .btn-guardar-prog:hover { background: #00838f; }

    .btn-cancelar-prog {
      background: #ccc;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
      margin-left: 10px;
      border-radius: 4px;
    }
    
    .btn-cancelar-prog:hover { background: #bbb; }

    /* Botones nuevos */
    .btn-aux {
      background-color: #607d8b;
      color: white;
    }
    .btn-aux:hover { background-color: #546e7a; }
    
    .btn-programar {
      background-color: #ff9800;
      color: white;
    }
    .btn-programar:hover { background-color: #f57c00; }

    /* Estilos generales de botones (si no existen) */
    .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        margin: 0 5px;
    }
  </style>
  <link rel="stylesheet" href="./css/remision.css?v=20251209">

  <!-- Cargar fuentes personalizadas -->
  <style>
    @font-face {
      font-family: 'Bauhaus';
      src: local('Bauhaus 93'), local('Bauhaus93');
    }

    .valor-u[contenteditable="true"] {
      direction: ltr;
      unicode-bidi: plaintext;
      text-align: left;
    }

    #form-transporte {
      display: none;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 10px;
      background-color: #f9f9f9;
    }

    .campo-form {
      margin-bottom: 10px;
    }

    #info-transporte {
      margin-top: 10px;
      font-size: 14px;
    }

    .checkbox-transporte {
      margin: 10px 0;
    }
  </style>

  <!-- Librer√≠as para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <div id="pdf-template" style="display:none; width: 21cm; background: white; padding: 1cm; box-sizing: border-box; font-family: Arial, sans-serif; position: absolute; top: 0; left: 0; z-index: -1000; color: black;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
        <!-- Logos -->
        <div style="display: flex; align-items: center; gap: 20px;">
            <img src="./img/LOGO4.webp" style="height: 60px; object-fit: contain;">
            <img src="./img/LOGO3.webp" style="height: 80px; object-fit: contain;">
        </div>
        <!-- Remission Box -->
        <div style="border: 1px solid #000; padding: 5px; border-radius: 10px; width: 220px; text-align: center; background: #f8f8f8;">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 2px;" id="pdf-header-date">FEC --/--/----</div>
            <div style="font-size: 20px; font-weight: bold; background: #e8e8e8; margin: 2px 0; padding: 4px; border-radius: 5px;" id="pdf-header-rem">REM ----</div>
            <div style="font-size: 14px; font-weight: bold;" id="pdf-header-cel">CEL 3197245235</div>
        </div>
    </div>

    <div style="border-top: 1px solid #000; margin-bottom: 15px;"></div>

    <!-- Info -->
    <div style="font-size: 11px; margin-bottom: 15px; line-height: 1.5;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <div id="pdf-info-fecha" style="font-weight: bold;">FECHA: --</div>
            <div style="display: flex; align-items: center;">
                <strong style="margin-right: 5px;">CLIENTE:</strong>
                <div id="pdf-info-cliente" style="border: 1px solid #ccc; padding: 2px 5px; width: 280px; background: #fff; min-height: 16px;"></div>
            </div>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <div>
                <div><strong>NIT:</strong> 901797743-2</div>
                <div><strong>DIR:</strong> CALLE 139#109-46</div>
            </div>
            <div style="text-align: right;">
                <strong>CEL:</strong> 3015827791 / 3197245235
            </div>
        </div>
    </div>

    <!-- Table -->
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 11px;">
        <thead>
            <tr style="background: #f0f0f0;">
                <th style="border: 1px solid #999; padding: 6px; width: 8%;">CANT</th>
                <th style="border: 1px solid #999; padding: 6px; width: 52%; text-align: left;">PRODUCTO</th>
                <th style="border: 1px solid #999; padding: 6px; width: 20%; text-align: right;">V.UNI</th>
                <th style="border: 1px solid #999; padding: 6px; width: 20%; text-align: right;">V. TOTAL</th>
            </tr>
        </thead>
        <tbody id="pdf-table-body">
            <!-- Rows will be populated here -->
        </tbody>
    </table>

    <!-- Footer -->
    <div style="text-align: center; margin-top: 10px;">
        <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;" id="pdf-total">TOTAL: $ 0</div>
        <div style="font-size: 10px; font-weight: bold; margin-bottom: 30px;">***GRACIAS POR SU COMPRA***</div>
        <div style="border-top: 1px solid #000; width: 250px; margin: 0 auto; padding-top: 5px; font-size: 11px;">Firma/Sello de Recibido</div>
    </div>
  </div>

  <script>
    window.jsPDF = window.jspdf.jsPDF;
  </script>
  <script>
    function logDebug(msg) {
      console.log(msg);
    }
  </script>
</head>

<body>

  <div id="login-overlay" class="login-overlay">
    <div class="login-box">
      <img src="./img/logo5.webp" alt="ALUMAS" class="login-logo">
      <h2>Acceso al sistema</h2>
      <input type="text" id="login-usuario" placeholder="Usuario">
      <input type="password" id="login-contrasena" placeholder="Contrase√±a">
      <button onclick="realizarLogin()">Ingresar</button>
      <div id="login-error" class="login-error"></div>
    </div>
  </div>

  <div id="conn-status" class="conn-status">Comprobando conexi√≥n‚Ä¶</div>
  <div id="user-bar" class="user-bar">
    <span id="user-name-prefix">USUARIO:</span>
    <span id="user-name"></span>
    <button type="button" id="logout-btn" onclick="logoutUsuario()">Cerrar sesi√≥n</button>
  </div>
  <div class="conn-spacer"></div>

  <div class="report-toggle" onclick="toggleReportePanel()">Reporte ‚ñº</div>

  <div class="panel-sugerencias" id="panel-sugerencias">
    <div class="panel-header">
      <span>Sugerencias de productos</span>
      <button class="panel-close" onclick="cerrarPanelSugerencias()">√ó</button>
    </div>
    <div class="panel-content">
      <div id="producto-autocomplete-dropdown" class="producto-dropdown">
        <div class="no-productos">Escribe en la columna descripci√≥n para ver sugerencias‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="contenedor-principal" id="contenido-factura">
    <div class="encabezado">
      <div>
        <div class="titulo"></div>
        <img src="./img/LOGO4.webp" alt="Logo ALUMAS" style="max-width: 300px; display: block; margin: 0 auto;">
      </div>
    </div>

    <div class="consecutivo-display" id="consecutivo-display">
      CONSECUTIVO: <span id="numero-consecutivo">----</span>
      <span class="edit-consecutivo" onclick="editarConsecutivo()" title="Editar consecutivo">‚úèÔ∏è</span>
    </div>

    <div class="info">
      <p id="fecha-actual"><strong>FECHA:</strong></p>
      <p>
        <strong>CLIENTE:</strong>
        <span class="cliente-container">
          <input type="text" id="nombre-cliente" class="cliente-input" placeholder="Buscar cliente por nombre o NIT...">
          <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
        </span>
      </p>
      <p><strong>NIT:</strong> 901797743-2</p>
      <p><strong>ATENCI√ìN AL CLIENTE:</strong> 3015827791</p>
      <p><strong>CONSULTAR ENV√çOS:</strong> 3197245235</p>
      <p class="nota-whatsapp"><strong>Por seguridad, solo atendemos llamadas y mensajes v√≠a WhatsApp.</strong></p>
      <p><strong>DIR:</strong> CALLE 139#109-46</p>
      <div id="info-transporte"></div>
    </div>

    <div class="checkbox-transporte">
      <input type="checkbox" id="activar-transporte" onchange="toggleTransporte()"> <label for="activar-transporte">A√±adir transporte</label>
    </div>
    <div class="metodos-pago">
      <label><input type="checkbox" id="pago-efectivo"> Efectivo</label>
      <label><input type="checkbox" id="pago-tarjeta"> Tarjeta</label>
      <label><input type="checkbox" id="pago-qr"> QR</label>
    </div>

    <div class="tipo-pago-selector" style="margin-top: 10px; margin-bottom: 10px;">
      <label for="select-tipo-pago"><strong>Tipo de pago:</strong></label>
      <select id="select-tipo-pago" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
        <option value="CONTADO" selected>Contado</option>
        <option value="CREDITO">Cr√©dito</option>
      </select>
    </div>

    <div class="punto-venta-selector" style="margin-top: 10px; margin-bottom: 10px;">
      <label for="select-punto-venta"><strong>Punto de Venta:</strong></label>
      <select id="select-punto-venta" onchange="actualizarPuntoVenta(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
        <option value="ferreteria">Ferreter√≠a</option>
        <option value="bodega">Bodega</option>
      </select>
    </div>

    <div id="form-transporte">
      <div class="campo-form">
        <label>Nombre del cliente:</label>
        <input type="text" id="trans-nombre">
      </div>
      <div class="campo-form">
        <label>Direcci√≥n de env√≠o:</label>
        <input type="text" id="trans-direccion">
      </div>
      <div class="campo-form">
        <label>Tel√©fono:</label>
        <input type="text" id="trans-telefono">
      </div>
      <div class="campo-form">
        <label>Costo del transporte:</label>
        <input type="number" id="trans-costo">
      </div>
      <button onclick="guardarTransporte()">Guardar transporte</button>
    </div>

    <div class="contenedor-tabla">
      <div class="acciones-tabla">
        <button onclick="agregarFila()">‚ûï</button>
        <button onclick="eliminarFila()">‚ûñ</button>
        <button onclick="limpiarTabla()">üßπ Limpiar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th class="col-cant">CANT</th>
            <th class="col-desc">DESCRIPCI√ìN</th>
            <th class="col-valor">VALOR U</th>
            <th class="col-valor">VALOR T</th>
   
          </tr>
        </thead>
        <tbody id="tabla-productos">
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
        </tbody>
      </table>
    </div>
  
    <p class="total" id="total-general">TOTAL: $ 0</p>
    

    <img src="./img/LOGO3.webp" alt="Logo ALUMAS" class="logo-grande">

    <div class="mensaje">
      <p><strong>***GRACIAS POR SU COMPRA***</strong></p>
      <small>SI NECESITA FACTURA ELECTR√ìNICA ENVIAR ESTA REMISI√ìN Y EL RUT AL 3015827791</small>
      <small>EL USO DE LA FACTURA ES INDISPENSABLE PARA CUALQUIER TIPO DE DEVOLUCI√ìN.</small>
      <small>NO SE REMBOLSA EL DINERO EN CASO QUE EL PRODUCTO NO CUMPLA CON EL FUNCIONAMIENTO.</small>
      <small>SE PUEDE CAMBIAR POR OTRO DEL MISMO VALOR SIEMPRE Y CUANDO EST√â EN BUEN ESTADO.</small>
      <div style="text-align: right; margin-top: 40px;">
        <img src="./img/firma.webp" alt="Firma" style="width:150px;filter:brightness(0) contrast(1000);-webkit-print-color-adjust:exact;print-color-adjust:exact;mix-blend-mode:multiply;">

      </div>
    </div>

    <div class="boton-imprimir">
      <button class="btn btn-cotizar" onclick="imprimirCotizacion()">Cotizar</button>
      <button class="btn btn-vender" onclick="imprimirVenta()">Vender</button>
      <button class="btn btn-pdf" onclick="descargarPDF()">Descargar PDF</button>
      <!-- <button class="btn btn-aux" onclick="descargarPDF(true)">‚ö° PDF R√°pido</button> -->
      <button class="btn btn-programar" onclick="abrirModalProgramacion()">üìÖ Programar</button>
    </div>
    <div id="report-panel" class="report-panel">
      <div class="report-header">
        <div style="display:flex; flex-direction:column; width:100%;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <span>Reporte Ventas</span>
            <button class="report-close" onclick="toggleReportePanel()">‚úñ</button>
          </div>
          <div class="pv-tabs" style="display:flex; gap:10px; margin-bottom:8px; border-bottom:1px solid #eee;">
            <button id="tab-ferreteria" class="pv-tab active" onclick="setFiltroPuntoVenta('ferreteria')">Ferreter√≠a</button>
            <button id="tab-bodega" class="pv-tab" onclick="setFiltroPuntoVenta('bodega')">Bodega</button>
          </div>
        </div>
      </div>
      <div id="reporte-lista" class="report-list"></div>
      <div id="reporte-suma" class="report-total"></div>
    </div>
  </div>

  <script>
    const tabla = document.getElementById('tabla-productos');
    let celdaActiva = null;
    let celdaProductoActiva = null;

    // --- VARIABLES Y FUNCIONES PARA MULTI-SELECCI√ìN ---
    let currentSuggestedProducts = [];
    let isMouseDown = false;

    function seleccionarProductosMultiples(listaProductos, celdaInicial) {
       if (!listaProductos || listaProductos.length === 0) return;
       
       let celdaDestino = celdaInicial;
       
       for (let i = 0; i < listaProductos.length; i++) {
           const prod = listaProductos[i];
           
           // Intentar usar la celda destino
           seleccionarProducto(prod, celdaDestino);
           
           // Verificar si efectivamente se llen√≥ esta celda (o si se unific√≥ en otra parte)
           // Si se unific√≥, celdaDestino estar√° vac√≠a (porque seleccionarProducto la limpia si unifica)
           // O mantendr√° su valor anterior si fall√≥ algo.
           // Pero seleccionarProducto pone el nombre si inserta.
           const seInsertoAqui = (celdaDestino.textContent === prod.nombre);
           
           if (seInsertoAqui) {
               // Si se ocup√≥ esta celda, avanzamos a la siguiente fila para el pr√≥ximo producto
               if (i < listaProductos.length - 1) {
                   let filaActual = celdaDestino.parentElement;
                   let filaSiguiente = filaActual.nextElementSibling;
                   
                   // Si no hay siguiente fila, crearla
                   if (!filaSiguiente) {
                       agregarFila();
                       filaSiguiente = filaActual.nextElementSibling;
                   }
                   
                   // Verificar si la siguiente fila est√° ocupada
                   let descSig = filaSiguiente.querySelector('td:nth-child(2)');
                   if (descSig.textContent.trim() !== '' || descSig.dataset.id) {
                       // Si est√° ocupada, insertar una nueva fila en medio para no sobrescribir
                       const nuevaFila = document.createElement('tr');
                       nuevaFila.innerHTML = `
                        <td class="cant"></td>
                        <td></td>
                        <td class="valor-u"></td>
                        <td class="valor-t"></td>
                       `;
                       filaActual.after(nuevaFila);
                       filaSiguiente = nuevaFila;
                   }
                   
                   celdaDestino = filaSiguiente.querySelector('td:nth-child(2)');
               }
           } else {
               // Si NO se insert√≥ aqu√≠ (se unific√≥ arriba), reutilizamos celdaDestino para el siguiente
               // No hacemos nada, el loop contin√∫a con el siguiente producto usando la misma celdaDestino
           }
       }
       
       // Asegurar foco en la √∫ltima celda usada o la siguiente disponible
       if (celdaDestino) {
           // Si qued√≥ vac√≠a (√∫ltimo unificado), intentar ir a la anterior o dejarlo ah√≠
           celdaDestino.focus();
       }
    }
  
    function formatearPesos(valor) {
      const numero = parseInt(valor);
      if (isNaN(numero)) return '$ 0';
      return '$ ' + numero.toLocaleString('es-CO');
    }
  
    function actualizarTotales() {
      let totalGeneral = 0;
  
      tabla.querySelectorAll('tr').forEach(fila => {
        const cant = parseInt(fila.querySelector('.cant')?.innerText || 0);
        const valorUCell = fila.querySelector('.valor-u');
        const valorUTxt = valorUCell?.innerText.replace(/[^\d]/g, '') || '0';
        const valorU = parseInt(valorUTxt);
  
        const totalFila = cant * valorU;
        const totalCelda = fila.querySelector('.valor-t');
        if (totalCelda) totalCelda.innerText = formatearPesos(totalFila);
  
        if (!isNaN(totalFila)) totalGeneral += totalFila;
      });
  
      document.getElementById('total-general').innerText = 'TOTAL: ' + formatearPesos(totalGeneral);
    }
  
    let inputDebounceTimer = null;

    tabla.addEventListener('input', async (e) => {
      const celda = e.target;
      if (celda.classList.contains('cant') || celda.classList.contains('valor-u')) {
        actualizarTotales();
      }
      const fila = celda.parentElement;
      if (!fila) return;
      const celdas = Array.from(fila.children);
      const indiceCelda = celdas.indexOf(celda);
      if (indiceCelda === 1) {
        delete celda.dataset.id;
        const texto = celda.textContent.trim();
        celdaProductoActiva = celda;
        if (texto.length < 2) {
          ocultarDropdownProductos();
          return;
        }
        
        if (inputDebounceTimer) clearTimeout(inputDebounceTimer);
        inputDebounceTimer = setTimeout(async () => {
             const productos = await buscarProductos(texto);
             
             // Auto-seleccionar si hay coincidencia exacta de c√≥digo de barras
             const exacto = productos.find(p => String(p.codigo_barras || '').trim().toLowerCase() === texto.toLowerCase());
             if (exacto) {
                // --- L√ìGICA DE UNIFICACI√ìN (Barcode - Input) ---
                let filaExistente = null;
                const filas = Array.from(tabla.querySelectorAll('tr'));
                
                for (let i = 0; i < filas.length; i++) {
                   const f = filas[i];
                   const celdaDesc = f.querySelector('td:nth-child(2)');
                   if (!celdaDesc) continue;
                   
                   if (f === fila) continue; 
                   
                   const idEnCelda = celdaDesc.dataset.id;
                   const nombreEnCelda = celdaDesc.textContent.trim();
                   
                   const coincideID = idEnCelda && String(idEnCelda) === String(exacto.id);
                   const coincideNombre = !idEnCelda && nombreEnCelda === exacto.nombre;
                   
                   if (coincideID || coincideNombre) {
                      filaExistente = f;
                      break;
                   }
                }
                
                if (filaExistente) {
                   const celdaCant = filaExistente.querySelector('.cant');
                   let cantActual = parseInt(celdaCant.innerText) || 0;
                   cantActual += 1;
                   celdaCant.innerText = cantActual;
                   
                   const celdaValorU = filaExistente.querySelector('.valor-u');
                   const valorUTxt = celdaValorU?.innerText.replace(/[^\d]/g, '') || '0';
                   const valorU = parseInt(valorUTxt);
                   const celdaTotal = filaExistente.querySelector('.valor-t');
                   if (celdaTotal) celdaTotal.innerText = formatearPesos(cantActual * valorU);
                   
                   // Limpiar la celda actual y mantener el foco para siguiente lectura
                   celda.textContent = '';
                   delete celda.dataset.id;
                   actualizarTotales();
                   return;
                }

                seleccionarProducto(exacto, celda);
                
                // L√≥gica para preparar siguiente l√≠nea (similar a Enter)
                const fila = celda.parentElement;
                if (!fila.nextElementSibling) {
                  agregarFila();
                }
                const siguienteFila = fila.nextElementSibling;
                if (siguienteFila) {
                   const nuevaCelda = siguienteFila.children[1]; // Columna descripci√≥n
                   if (nuevaCelda) {
                      nuevaCelda.setAttribute('contenteditable', 'true');
                      nuevaCelda.focus();
                      celdaActiva = nuevaCelda;
                   }
                }
                return;
             }

             mostrarDropdownProductos(productos, celda);
        }, 200);
      }
    });
  
    // --- L√ìGICA DE SELECCI√ìN DE FILA (4 CLICKS) ---
    tabla.addEventListener('click', (e) => {
      // Manejar selecci√≥n m√∫ltiple con clicks repetidos
      if (e.detail === 4) { // Detectar 4 clicks
        const fila = e.target.closest('tr');
        if (fila) {
           // Quitar selecci√≥n previa
           tabla.querySelectorAll('tr.fila-seleccionada').forEach(f => f.classList.remove('fila-seleccionada'));
           
           // Seleccionar nueva
           fila.classList.add('fila-seleccionada');
           
           // Feedback visual temporal
           fila.style.backgroundColor = '#e0f7fa'; // Color cyan suave
        }
      }
    });

    // Limpiar selecci√≥n si se hace click fuera (opcional, pero buena UX)
    document.addEventListener('click', (e) => {
       if (!e.target.closest('#tabla-productos')) {
          tabla.querySelectorAll('tr.fila-seleccionada').forEach(f => {
             f.classList.remove('fila-seleccionada');
             f.style.backgroundColor = ''; // Restaurar color
          });
       }
    });

    function agregarFila() {
      // Si hay una fila seleccionada, agregar DESPU√âS de ella
      const seleccionada = tabla.querySelector('tr.fila-seleccionada');
      
      const nuevaFila = document.createElement('tr');
      nuevaFila.innerHTML = `
        <td class="cant"></td>
        <td></td>
        <td class="valor-u"></td>
        <td class="valor-t"></td>
      `;

      if (seleccionada && seleccionada.parentNode === tabla) {
          seleccionada.after(nuevaFila);
          // Limpiar selecci√≥n despu√©s de agregar
          seleccionada.classList.remove('fila-seleccionada');
          seleccionada.style.backgroundColor = '';
      } else {
          // Comportamiento normal: al final
          tabla.appendChild(nuevaFila);
      }
      
      actualizarFechaHora();
      actualizarTotales();
    }
  
    function eliminarFila() {
      // 1. Intentar eliminar fila seleccionada expl√≠citamente
      const seleccionada = tabla.querySelector('tr.fila-seleccionada');
      if (seleccionada) {
         seleccionada.remove();
         actualizarTotales();
         actualizarFechaHora();
         return;
      }

      // 2. Comportamiento normal: eliminar la √∫ltima
      const filas = tabla.querySelectorAll('tr');
      if (filas.length > 1) {
        tabla.removeChild(filas[filas.length - 1]);
        actualizarTotales();
        actualizarFechaHora();
      }
    }
  
    function limpiarTabla() {
      tabla.querySelectorAll('tr').forEach(fila => {
        fila.querySelectorAll('td').forEach(celda => {
          if (!celda.classList.contains('valor-t')) {
            celda.textContent = '';
            delete celda.dataset.id;
          } else {
            celda.innerText = '';
          }
          actualizarFechaHora();
        });
      });
  
      actualizarTotales();
  
      // Limpiar datos en pantalla
      document.getElementById('nombre-cliente').value = '';
      document.getElementById('tipo-pago').value = 'CONTADO';
      document.getElementById('total-general').innerText = 'TOTAL: $ 0';
      
      // Limpiar variable global de cliente
      clienteSeleccionado = null; 
      localStorage.removeItem('CLIENTE_ID'); 

      // Limpiar transporte
      document.getElementById('trans-nombre').value = '';
      document.getElementById('trans-direccion').value = '';
      document.getElementById('trans-telefono').value = '';
      document.getElementById('trans-costo').value = '';
      document.getElementById('info-transporte').innerHTML = '';

      tabla.querySelectorAll('tr').forEach(fila => {
          const descripcion = fila.cells[1]?.textContent.trim();
          if (descripcion === 'TRANSPORTE') {
            tabla.removeChild(fila);
          }
      });
    }
  
    function prepararDatosPDF() {
      // Check context
      const consecutivoDisplay = document.getElementById('consecutivo-display');
      const isCotizacion = consecutivoDisplay && consecutivoDisplay.style.visibility === 'hidden';

      // 1. Preparar datos en la plantilla oculta
      const tbody = document.getElementById('pdf-table-body');
      
      // Fecha header
      const now = new Date();
      const dateStr = now.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
      const elDate = document.getElementById('pdf-header-date');
      if (elDate) elDate.textContent = `FEC ${dateStr}`;
      
      // Consecutivo / Titulo
      const elRem = document.getElementById('pdf-header-rem');
      if (elRem) {
          if (isCotizacion) {
              elRem.textContent = 'COTIZACI√ìN';
          } else {
              const consecutivo = document.getElementById('numero-consecutivo').textContent;
              elRem.textContent = `REM ${consecutivo}`;
          }
      }
      
      // Fecha Info
      const fullDateStr = now.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' }) + ', ' + 
                          now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }).toLowerCase();
      const elInfoFecha = document.getElementById('pdf-info-fecha');
      if (elInfoFecha) elInfoFecha.innerHTML = `<strong>FECHA:</strong> ${fullDateStr}`;
      
      // Cliente
      const clienteVal = document.getElementById('nombre-cliente').value || '';
      const elInfoCliente = document.getElementById('pdf-info-cliente');
      if (elInfoCliente) elInfoCliente.textContent = clienteVal;
      
      // Tabla
      if (tbody) {
        tbody.innerHTML = '';
        const filas = document.querySelectorAll('#tabla-productos tr');
        
        let totalFilas = 0;
        filas.forEach(fila => {
            const cels = fila.querySelectorAll('td');
            const cant = cels[0]?.innerText || '';
            const desc = cels[1]?.innerText || '';
            const vuni = cels[2]?.innerText || '';
            const vtot = cels[3]?.innerText || '';
            
            // Solo agregar si tiene contenido
            if (cant || desc || vuni || vtot) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #999; padding: 6px; text-align: center;">${cant}</td>
                    <td style="border: 1px solid #999; padding: 6px; text-align: left;">${desc}</td>
                    <td style="border: 1px solid #999; padding: 6px; text-align: right;">${vuni}</td>
                    <td style="border: 1px solid #999; padding: 6px; text-align: right; font-weight: bold;">${vtot}</td>
                `;
                tbody.appendChild(tr);
                totalFilas++;
            }
        });
        
        // Rellenar l√≠neas vac√≠as hasta completar 8 filas visuales
        while (totalFilas < 8) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="border: 1px solid #999; padding: 6px; height: 18px;"></td>
                    <td style="border: 1px solid #999; padding: 6px;"></td>
                    <td style="border: 1px solid #999; padding: 6px;"></td>
                    <td style="border: 1px solid #999; padding: 6px;"></td>
                `;
                tbody.appendChild(tr);
                totalFilas++;
        }
      }
      
      // Total
      const totalTxt = document.getElementById('total-general').innerText;
      const elTotal = document.getElementById('pdf-total');
      if (elTotal) elTotal.innerText = totalTxt;
    }

    async function descargarPDF(silent = false) {
      // 1. Preparar datos en la plantilla oculta
      prepararDatosPDF();
      const template = document.getElementById('pdf-template');

      // Mostrar temporalmente para html2canvas
      template.style.display = 'block';
      
      try {
        const canvas = await html2canvas(template, {
            scale: 2,
            useCORS: true
        });
        
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF({ 
          orientation: 'portrait', 
          unit: 'mm', 
          format: 'a5' // Media carta aprox
        });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        
        const pv = getPuntoVenta();
        const nombre = (lastConsecutivo ? `${lastConsecutivo}_${pv}.pdf` : `remision_${pv}.pdf`);
        
        // Descarga directa local (El navegador gestionar√° la ubicaci√≥n)
        // Por seguridad, los navegadores no permiten forzar la ruta G:\...
        // El usuario debe configurar su navegador o elegir la ruta al guardar.
        if (!silent) {
            alert(`‚ö†Ô∏è Para guardar en la unidad G:, selecciona esa carpeta cuando aparezca la ventana de guardar.\n\nArchivo: ${nombre}`);
        }
        pdf.save(nombre);
        
      } catch (e) {
        console.error(e);
        alert('Error generando PDF');
      } finally {
        template.style.display = 'none';
      }
    }
    async function guardarPDFAutoServer() {
      // Reutiliza la l√≥gica de generaci√≥n pero env√≠a al servidor
      prepararDatosPDF();
      const template = document.getElementById('pdf-template');

      template.style.display = 'block';
      
      try {
        const canvas = await html2canvas(template, {
            scale: 2,
            useCORS: true
        });
        
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF({ 
          orientation: 'portrait', 
          unit: 'mm', 
          format: 'a5' 
        });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        
        const pv = getPuntoVenta();
        const nombre = (lastConsecutivo ? `${lastConsecutivo}_${pv}.pdf` : `remision_${pv}.pdf`);
        
        // Convertir a base64 para enviar
        const pdfBase64 = pdf.output('datauristring').split(',')[1];
        
        // Enviar al servidor
        const resp = await fetch(getApiBase() + '/api/save-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: nombre, data: pdfBase64 })
        });
        
        if (resp.ok) {
            console.log("PDF guardado en servidor correctamente");
        } else {
            const errInfo = await resp.json();
            console.error("Error guardando PDF en servidor:", errInfo);
            alert("Error del servidor al guardar PDF: " + (errInfo.error || 'Desconocido'));
        }

      } catch (e) {
        console.error('Error generando/guardando PDF auto:', e);
      } finally {
        template.style.display = 'none';
      }
    }

    async function buscarProductos(termino) {
      try {
        const url = getApiBase() + '/api/productos?q=' + encodeURIComponent(termino);
        // logDebug('Fetch URL: ' + url);
        const resp = await fetch(url);
        if (!resp.ok) {
            logDebug('Error API: ' + resp.status);
            return [];
        }
        const data = await resp.json();
        if (!data || !Array.isArray(data.productos)) {
            logDebug('API sin productos');
            return [];
        }
        return data.productos;
      } catch (e) {
        logDebug('Excepcion buscarProductos: ' + e.message);
        return [];
      }
    }
    function precioPorCliente(producto) {
      try {
        const tipo = (clienteSeleccionado && clienteSeleccionado.tipo_cliente) ? String(clienteSeleccionado.tipo_cliente).toLowerCase() : '';
        const esMayorista = tipo.includes('mayor');
        const precio = esMayorista ? producto.precio_mayorista : producto.precio_final;
        return Number(precio || 0);
      } catch (e) {
        return Number(producto.precio_final || 0);
      }
    }
    function mostrarDropdownProductos(productos, celda) {
      const dropdown = document.getElementById('producto-autocomplete-dropdown');
      const panel = document.getElementById('panel-sugerencias');
      if (!dropdown || !panel) return;
      celdaProductoActiva = celda;
      currentSuggestedProducts = productos; // Guardar referencia
      dropdown.innerHTML = '';
      if (!productos || productos.length === 0) {
        dropdown.innerHTML = '<div class="no-productos">No se encontraron productos que coincidan con la b√∫squeda.</div>';
        panel.style.display = 'block';
        return;
      }
      
      isMouseDown = false; // Reset

      productos.forEach((producto, index) => {
        const item = document.createElement('div');
        item.className = 'producto-item';
        item.dataset.index = index;
        
        if (index === 0) item.classList.add('selected');
        
        const precioFinal = Number(producto.precio_final || 0);
        const precioMayor = Number(producto.precio_mayorista || 0);
        item.innerHTML = `
          <div class="producto-nombre">${producto.nombre}</div>
          <div class="producto-info">ID: ${producto.id || ''} | Stock: ${producto.stock || 0}</div>
          <div class="producto-info">Final: ${formatearPesos(precioFinal)} | Mayor: ${formatearPesos(precioMayor)}</div>
        `;
        
        // Eventos Mouse para Selecci√≥n
        item.addEventListener('mousedown', (e) => {
             isMouseDown = true;
             // Si no presiona Ctrl/Shift, limpiar selecci√≥n previa
             if (!e.ctrlKey && !e.shiftKey) {
                 dropdown.querySelectorAll('.producto-item.selected').forEach(el => el.classList.remove('selected'));
             }
             item.classList.add('selected');
        });
        
        item.addEventListener('mouseenter', () => {
             if (isMouseDown) {
                 item.classList.add('selected');
             }
        });
        
        item.addEventListener('click', (e) => {
             const selected = dropdown.querySelectorAll('.producto-item.selected');
             if (selected.length > 1) {
                 // Si hay varios seleccionados (por arrastre), esperamos ENTER
                 return; 
             }
             seleccionarProducto(producto, celda);
        });

        dropdown.appendChild(item);
      });
      
      // Listener para terminar arrastre
      document.addEventListener('mouseup', () => { isMouseDown = false; }, { once: true });

      panel.style.display = 'block';
    }
    function cerrarPanelSugerencias() {
      const panel = document.getElementById('panel-sugerencias');
      if (panel) panel.style.display = 'none';
      celdaProductoActiva = null;
    }
    function ocultarDropdownProductos() {
      cerrarPanelSugerencias();
      celdaProductoActiva = null;
    }
    function seleccionarProducto(producto, celda) {
      // 1. Verificar si el producto ya existe en otra fila (Unificaci√≥n)
      let filaExistente = null;
      const filas = Array.from(tabla.querySelectorAll('tr'));
      
      for (let i = 0; i < filas.length; i++) {
         const f = filas[i];
         const celdaDesc = f.querySelector('td:nth-child(2)');
         if (!celdaDesc) continue;
         
         // Ignorar la fila actual
         if (f === celda.parentElement) continue; 
         
         const idEnCelda = celdaDesc.dataset.id;
         const nombreEnCelda = celdaDesc.textContent.trim();
         
         // Coincidencia por ID o Nombre exacto
         const coincideID = idEnCelda && String(idEnCelda) === String(producto.id);
         const coincideNombre = !idEnCelda && nombreEnCelda === producto.nombre;
         
         if (coincideID || coincideNombre) {
            filaExistente = f;
            break;
         }
      }
      
      if (filaExistente) {
         // --- YA EXISTE: INCREMENTAR ---
         const celdaCant = filaExistente.querySelector('.cant');
         let cantActual = parseInt(celdaCant.innerText) || 0;
         cantActual += 1;
         celdaCant.innerText = cantActual;
         
         // Actualizar total fila
         const celdaValorU = filaExistente.querySelector('.valor-u');
         const valorUTxt = celdaValorU?.innerText.replace(/[^\d]/g, '') || '0';
         const valorU = parseInt(valorUTxt);
         const celdaTotal = filaExistente.querySelector('.valor-t');
         if (celdaTotal) celdaTotal.innerText = formatearPesos(cantActual * valorU);
         
         // Limpiar celda actual
         celda.textContent = '';
         delete celda.dataset.id;
         
         cerrarPanelSugerencias();
         actualizarTotales();
         celda.focus(); // Mantener foco para seguir escaneando/buscando
         return;
      }

      // --- NO EXISTE: LLENAR FILA ACTUAL ---
      celda.textContent = producto.nombre;
      celda.dataset.id = producto.id;
      const fila = celda.parentElement;
      if (!fila) return;
      const celdas = Array.from(fila.children);
      const indiceCelda = celdas.indexOf(celda);
      
      // Asignar cantidad 1 si vac√≠a
      let celdaCant = fila.querySelector('.cant'); // Cambiado a 'let' o reutilizar variable existente
      if (celdaCant && (celdaCant.innerText.trim() === '' || celdaCant.innerText.trim() === '0')) {
         celdaCant.innerText = '1';
      }

      if (indiceCelda === 1) {
        const celdaPrecio = celdas[2];
        if (celdaPrecio) {
          const precio = precioPorCliente(producto);
          celdaPrecio.textContent = String(precio);
        }
      }
      cerrarPanelSugerencias();
      actualizarTotales();

      // --- PREPARAR SIGUIENTE FILA (pero quedarse en CANTIDAD) ---
      if (!fila.nextElementSibling) {
        agregarFila();
      }
      
      // Mover foco a CANTIDAD de la fila actual y seleccionar
      // Volvemos a seleccionar porque pudo perderse referencia o por claridad
      celdaCant = fila.querySelector('.cant'); 
      if (celdaCant) {
         // Asegurar contenteditable
         celdaCant.setAttribute('contenteditable', 'true');
         celdaCant.focus();
         // Seleccionar todo el contenido (el "1")
         const range = document.createRange();
         range.selectNodeContents(celdaCant);
         const sel = window.getSelection();
         sel.removeAllRanges();
         sel.addRange(range);
         celdaActiva = celdaCant;
      }
    }
  function toggleTransporte() {
  const form = document.getElementById('form-transporte');
  const mensajeTransporte = document.getElementById('mensaje-transporte');

  form.style.display = document.getElementById('activar-transporte').checked ? 'block' : 'none';

  if (document.getElementById('activar-transporte').checked) {
    // Si hay un cliente seleccionado, rellenar datos autom√°ticamente
    if (clienteSeleccionado) {
      document.getElementById('trans-nombre').value = clienteSeleccionado.nombre || '';
      document.getElementById('trans-direccion').value = clienteSeleccionado.direccion || '';
      document.getElementById('trans-telefono').value = clienteSeleccionado.telefono || '';
    }

    if (!mensajeTransporte) {
      const mensaje = document.createElement('div');
      mensaje.id = 'mensaje-transporte';
      mensaje.innerHTML = `
        <p style="font-size: 22px; font-weight: bold; text-align: center; margin-top: 40px;">
          IMPORTANTE: TODO ENV√çO O DOMICILIO SE ENTREGA HASTA DONDE TENGA ACCESO EL VEH√çCULO DE TRANSPORTE. 
          EL CONDUCTOR O TRANSPORTADOR NO EST√Å AUTORIZADO A MANIPULAR LA MERCANC√çA M√ÅS ALL√Å DEL PRIMER PISO. 
          EN CASO DE HACER CASO OMISO A ESTA INSTRUCCI√ìN, EL TRABAJADOR PUEDE SER SANCIONADO POR LA EMPRESA.
        </p>
      `;
      const mensajeDiv = document.querySelector('.mensaje');
      mensajeDiv.parentNode.insertBefore(mensaje, mensajeDiv);
    }
  } else {
    if (mensajeTransporte) {
      mensajeTransporte.remove();
    }
  }
}

  
    function guardarTransporte() {
      const nombre = document.getElementById('trans-nombre').value;
      const direccion = document.getElementById('trans-direccion').value;
      const telefono = document.getElementById('trans-telefono').value;
      const costo = parseInt(document.getElementById('trans-costo').value) || 0;
  
      document.getElementById('nombre-cliente').innerText = nombre;
      document.getElementById('info-transporte').innerHTML = ``;
  
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td class="cant">1</td>
        <td>TRANSPORTE</td>
        <td class="valor-u">${costo}</td>
        <td class="valor-t">${formatearPesos(costo)}</td>
      `;
      tabla.appendChild(fila);
      actualizarTotales();
    }
  
    tabla.addEventListener('focusin', (e) => {
      const celda = e.target.closest('td');
      if (celda && !celda.classList.contains('valor-t')) {
        celdaActiva = celda;
      }
    });

    tabla.addEventListener('click', (e) => {
      const celda = e.target.closest('td');
      if (!celda || celda.classList.contains('valor-t')) return;
      celda.setAttribute('contenteditable', 'true');
      celda.focus();
      celdaActiva = celda;
    });
  
    tabla.addEventListener('dblclick', (e) => {
      const celda = e.target.closest('td');
      if (celda && !celda.classList.contains('valor-t')) {
        celda.setAttribute('contenteditable', 'true');
        celda.focus();
      }
    });
  
    tabla.addEventListener('keydown', async (e) => {
      // --- MANEJO DE SUGERENCIAS Y NAVEGACI√ìN ---
      const panel = document.getElementById('panel-sugerencias');
      const dropdown = document.getElementById('producto-autocomplete-dropdown');
      const sugerenciasVisibles = panel && panel.style.display !== 'none' && dropdown && dropdown.children.length > 0;

      if (sugerenciasVisibles) {
         const items = Array.from(dropdown.querySelectorAll('.producto-item'));
         
         if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (e.shiftKey) {
                // Selecci√≥n m√∫ltiple hacia abajo
                let lastIdx = -1;
                items.forEach((it, idx) => {
                    if (it.classList.contains('selected')) lastIdx = idx;
                });
                
                if (lastIdx < items.length - 1) {
                    const next = items[lastIdx + 1];
                    next.classList.add('selected');
                    next.scrollIntoView({ block: 'nearest' });
                }
            } else {
                // Navegaci√≥n simple
                let selectedIndex = items.findIndex(item => item.classList.contains('selected'));
                if (selectedIndex === -1) selectedIndex = 0;
                
                const nextIndex = (selectedIndex + 1) % items.length;
                items.forEach(i => i.classList.remove('selected'));
                items[nextIndex].classList.add('selected');
                items[nextIndex].scrollIntoView({ block: 'nearest' });
            }
            return;
         }
         
         if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (e.shiftKey) {
                // Selecci√≥n m√∫ltiple hacia arriba
                let firstIdx = items.length;
                items.forEach((it, idx) => {
                    if (it.classList.contains('selected') && idx < firstIdx) firstIdx = idx;
                });
                
                if (firstIdx > 0) {
                    const prev = items[firstIdx - 1];
                    prev.classList.add('selected');
                    prev.scrollIntoView({ block: 'nearest' });
                }
            } else {
                // Navegaci√≥n simple
                let selectedIndex = items.findIndex(item => item.classList.contains('selected'));
                if (selectedIndex === -1) selectedIndex = 0;
                
                const prevIndex = (selectedIndex - 1 + items.length) % items.length;
                items.forEach(i => i.classList.remove('selected'));
                items[prevIndex].classList.add('selected');
                items[prevIndex].scrollIntoView({ block: 'nearest' });
            }
            return;
         }

         if (e.key === 'Enter') {
            e.preventDefault();
            const selectedItems = dropdown.querySelectorAll('.producto-item.selected');
            if (selectedItems.length > 0) {
                if (selectedItems.length === 1) {
                     // Click simple
                     selectedItems[0].click();
                } else {
                     // M√∫ltiples
                     const selectedProducts = [];
                     selectedItems.forEach(item => {
                         const idx = parseInt(item.dataset.index);
                         if (currentSuggestedProducts[idx]) {
                             selectedProducts.push(currentSuggestedProducts[idx]);
                         }
                     });
                     seleccionarProductosMultiples(selectedProducts, celdaProductoActiva);
                }
                return;
            }
         }
         
         if (e.key === 'Escape') {
            e.preventDefault();
            cerrarPanelSugerencias();
            return;
         }
      }

      const celda = e.target.closest('td');
      if (celda) celdaActiva = celda;
      
      // Debug key
      // logDebug('Key: ' + e.key + ' Code: ' + e.code);

      if (!celdaActiva) return;
  
      const fila = celdaActiva.parentElement;
      const columnas = Array.from(fila.children);
      const colIndex = columnas.indexOf(celdaActiva);
      let nuevaCelda;
  
      switch (e.key) {
        case 'ArrowRight':
          nuevaCelda = fila.children[colIndex + 1];
          break;
        case 'ArrowLeft':
          nuevaCelda = fila.children[colIndex - 1];
          break;
        case 'ArrowDown':
          const filaAbajo = fila.nextElementSibling;
          if (filaAbajo) nuevaCelda = filaAbajo.children[colIndex];
          break;
        case 'ArrowUp':
          const filaArriba = fila.previousElementSibling;
          if (filaArriba) nuevaCelda = filaArriba.children[colIndex];
          break;
        case 'Enter':
          e.preventDefault();

          // L√≥gica para autocompletar con c√≥digo de barras (Match Exacto)
          if (colIndex === 1) {
            const termino = celdaActiva.textContent.trim();
            if (termino) {
              const productos = await buscarProductos(termino);
              
              // Buscar coincidencia exacta
              const encontrado = productos.find(p => 
                String(p.id) === termino || 
                String(p.codigo || '').toLowerCase() === termino.toLowerCase() ||
                String(p.codigo_barras || '').toLowerCase() === termino.toLowerCase() ||
                String(p.referencia || '').toLowerCase() === termino.toLowerCase() ||
                p.nombre.toLowerCase() === termino.toLowerCase()
              );

              if (encontrado) {
                seleccionarProducto(encontrado, celdaActiva);
                return;
              }
            }
          }

          // Navegaci√≥n inteligente
          if (celdaActiva && celdaActiva.classList.contains('cant')) {
              // Si estoy en CANTIDAD -> Ir a la siguiente fila, columna DESCRIPCI√ìN
              let sigFila = fila.nextElementSibling;
              if (!sigFila) {
                  agregarFila();
                  sigFila = fila.nextElementSibling;
              }
              if (sigFila) {
                  nuevaCelda = sigFila.children[1]; // Descripci√≥n es √≠ndice 1
                  // Asegurar que sea editable
                  if (nuevaCelda) {
                      nuevaCelda.setAttribute('contenteditable', 'true');
                      // Peque√±o delay para asegurar que el DOM est√© listo
                      setTimeout(() => {
                          nuevaCelda.focus();
                          celdaActiva = nuevaCelda;
                      }, 10);
                      return; // Salir aqu√≠ para evitar conflictos con el foco
                  }
              }
          } else {
              // Comportamiento default: Bajar a la misma columna de la siguiente fila
              const siguienteFila = fila.nextElementSibling;
              if (siguienteFila) nuevaCelda = siguienteFila.children[colIndex];
          }
          break;
      }
  
      if (nuevaCelda && !nuevaCelda.classList.contains('valor-t')) {
        nuevaCelda.setAttribute('contenteditable', 'true');
        nuevaCelda.focus();
        celdaActiva = nuevaCelda;
      }
    });
  
    tabla.addEventListener('blur', (e) => {
      const celda = e.target.closest('td');
      if (celda && !celda.classList.contains('valor-t')) {
        celda.removeAttribute('contenteditable');
      }
    }, true);
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.contenedor-tabla') &&
          !e.target.closest('#panel-sugerencias') &&
          !e.target.closest('#producto-autocomplete-dropdown')) {
        cerrarPanelSugerencias();
      }
    });
    let originalMensajeHTML = '';
    document.addEventListener('DOMContentLoaded', () => {
      const mensajeDiv = document.querySelector('.mensaje');
      originalMensajeHTML = mensajeDiv ? mensajeDiv.innerHTML : '';
    });

    function aplicarCotizacionUI() {
      const mensajeDiv = document.querySelector('.mensaje');
      if (mensajeDiv) {
        mensajeDiv.innerHTML = `
          <p style="font-size: 22px; font-weight: bold; text-align: center; margin-top: 40px;">
            COTIZACI√ìN - NO V√ÅLIDO COMO COMPROBANTE DE COMPRA
          </p>
        `;
      }
      document.querySelectorAll('.logo-grande').forEach(logo => logo.style.display = 'none');
      const consecutivoDisplay = document.getElementById('consecutivo-display');
      if (consecutivoDisplay) consecutivoDisplay.style.visibility = 'hidden';
    }

    function aplicarVentaUI() {
      const mensajeDiv = document.querySelector('.mensaje');
      if (mensajeDiv && originalMensajeHTML) {
        mensajeDiv.innerHTML = originalMensajeHTML;
      }
      document.querySelectorAll('.logo-grande').forEach(logo => logo.style.display = 'block');
      const consecutivoDisplay = document.getElementById('consecutivo-display');
      if (consecutivoDisplay) consecutivoDisplay.style.visibility = 'visible';
    }

    function imprimirCotizacion() {
      aplicarCotizacionUI();
      window.print();
    }

    async function imprimirVenta() {
      const tipo = getTipoPago();
      const metodo = getSelectedMetodoPago();
      if (tipo !== 'CREDITO' && !metodo) {
        alert('Seleccione un m√©todo de pago (Efectivo, Tarjeta o QR)');
        return;
      }
      aplicarVentaUI();
      let ok = false
      try {
        ok = await guardarVentaBD(metodo);
      } catch (e) {
        alert('Error guardando la venta');
        return;
      }
      if (!ok) {
        alert('La venta no se pudo guardar. Intente de nuevo.');
        return;
      }

      // Guardar PDF autom√°ticamente si es Bodega (ELIMINADO POR SOLICITUD DE MANUALIDAD)
      /* 
      if (getPuntoVenta() === 'bodega') {
          ...
      }
      */

      const mensaje = lastConsecutivo
        ? 'La venta se guard√≥ correctamente con consecutivo ' + lastConsecutivo + '. ¬øDesea imprimir la remisi√≥n?'
        : 'La venta se guard√≥ correctamente. ¬øDesea imprimir la remisi√≥n?';
      const confirmar = window.confirm(mensaje);
      if (confirmar) {
        const metodoReporte = metodo || (tipo === 'CREDITO' ? 'credito' : null);
        if (metodoReporte) agregarVentaReporte(metodoReporte);
        window.print();
      }
      // Limpiar datos despu√©s de imprimir/guardar
      setTimeout(limpiarTabla, 1000);

      window.location.reload();
    }

    window.addEventListener('beforeprint', () => {
      if (getPuntoVenta() === 'bodega') {
        prepararDatosPDF();
      }
    });

    window.addEventListener('afterprint', () => {
      aplicarVentaUI();
      ['pago-efectivo','pago-tarjeta','pago-qr'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = false;
      });
    });

    window.addEventListener('keydown', (e) => {
      // Toggle debug con Ctrl+D
      if (e.ctrlKey && e.key === 'd') {
          e.preventDefault();
          const d = document.getElementById('debug-log');
          if (d) d.style.display = (d.style.display === 'none' ? 'block' : 'none');
      }

      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    });
    let dbHost = null
    function getApiBase() {
      const qs = new URLSearchParams(window.location.search)
      const manual = qs.get('api_base') || localStorage.getItem('API_BASE')
      if (manual) return manual
      return window.location.origin
    }
    async function loadDbInfo() {
      try {
        const r = await fetch(getApiBase() + '/api/db-info')
        const data = await r.json()
        dbHost = data?.host || null
      } catch {}
    }
    async function checkConexion() {
      const el = document.getElementById('conn-status')
      try {
        const c = new AbortController()
        const t = setTimeout(() => c.abort(), 4000)
        const r = await fetch(getApiBase() + '/api/db-ping', { signal: c.signal })
        clearTimeout(t)
        const data = await r.json()
        const ok = !!data?.ok
        el.classList.toggle('conn-ok', ok)
        el.classList.toggle('conn-bad', !ok)
        const hostTxt = dbHost ? ` ${dbHost}` : ''
        el.textContent = ok ? `Conexi√≥n a BD${hostTxt} ‚úî` : `Conexi√≥n a BD${hostTxt} ‚úñ`
      } catch (e) {
        el.classList.add('conn-bad')
        el.classList.remove('conn-ok')
        const hostTxt = dbHost ? ` ${dbHost}` : ''
        el.textContent = `Conexi√≥n a BD${hostTxt} ‚úñ`
      }
    }
    let reporteVentas = [];
    let filtroMetodo = 'todos';
    // function checkResetReporte() { ... } eliminada
    async function cargarReporte() {
      try {
        const resp = await fetch(getApiBase() + '/api/reporte-ventas')
        if (resp.ok) {
          const data = await resp.json()
          if (data.ok && Array.isArray(data.ventas)) {
            const hoy = new Date()
            const y = hoy.getFullYear()
            const m = hoy.getMonth()
            const d = hoy.getDate()
            const soloHoy = data.ventas.filter(v => {
              if (!v.fecha) return false
              const fv = new Date(v.fecha)
              return fv.getFullYear() === y && fv.getMonth() === m && fv.getDate() === d
            })
            console.log('Ventas cargadas (todas):', data.ventas.length)
            console.log('Ventas filtradas hoy:', soloHoy.length)
            reporteVentas = soloHoy.map(v => ({
              id: v.id_consecutivo,
              v: parseInt(v.total) || 0,
              m: (v.forma_pago || 'desconocido').toLowerCase(),
              pv: (v.punto_venta || 'ferreteria').toLowerCase(),
              fecha: v.fecha
            }))
            actualizarUIReporte()
            return
          }
        } else {
          console.error('Error fetch reporte', resp.status)
        }
      } catch (e) {
        console.error('Error cargando reporte BD', e)
      }
    }
    function mostrarLogin() {
      const overlay = document.getElementById('login-overlay')
      if (overlay) overlay.style.display = 'flex'
      document.body.classList.add('login-active')
    }
    function ocultarLogin() {
      const overlay = document.getElementById('login-overlay')
      if (overlay) overlay.style.display = 'none'
      document.body.classList.remove('login-active')
    }
    function actualizarUserBar() {
      const bar = document.getElementById('user-bar')
      const nameEl = document.getElementById('user-name')
      if (!bar || !nameEl) return
      const nombre = localStorage.getItem('USUARIO_NOMBRE') || ''
      if (nombre) {
        nameEl.textContent = nombre
        bar.style.display = 'flex'
      } else {
        nameEl.textContent = ''
        bar.style.display = 'none'
      }
    }
    function logoutUsuario() {
      localStorage.removeItem('USUARIO_ID')
      localStorage.removeItem('USUARIO_NOMBRE')
      localStorage.removeItem('USUARIO_ROL')
      actualizarUserBar()
      mostrarLogin()
    }
    let inactivityTimer = null
    function resetInactividad() {
      if (inactivityTimer) clearTimeout(inactivityTimer)
      inactivityTimer = setTimeout(() => {
        const usuarioId = localStorage.getItem('USUARIO_ID')
        if (usuarioId) {
          logoutUsuario()
          alert('La sesi√≥n se cerr√≥ por inactividad')
        }
      }, 30 * 60 * 1000)
    }
    async function realizarLogin() {
      const usuario = document.getElementById('login-usuario')?.value.trim() || ''
      const contrasena = document.getElementById('login-contrasena')?.value || ''
      const errorEl = document.getElementById('login-error')
      if (errorEl) {
        errorEl.textContent = ''
        errorEl.style.color = ''
      }
      if (!usuario || !contrasena) {
        if (errorEl) errorEl.textContent = 'Ingrese usuario y contrase√±a'
        return
      }
      try {
        const resp = await fetch(getApiBase() + '/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario, contrasena })
        })
        if (!resp.ok) {
          if (errorEl) errorEl.textContent = 'Credenciales inv√°lidas'
          return
        }
        const data = await resp.json()
        if (!data?.ok || !data?.usuario_id) {
          if (errorEl) errorEl.textContent = 'Credenciales inv√°lidas'
          return
        }
        localStorage.setItem('USUARIO_ID', String(data.usuario_id))
        if (data.usuario) localStorage.setItem('USUARIO_NOMBRE', data.usuario)
        localStorage.setItem('USUARIO_ROL', data.rol || 'vendedor')
        actualizarUserBar()
        if (errorEl) {
          errorEl.style.color = '#16a34a'
          errorEl.textContent = 'BIENVENIDO ' + (data.usuario || usuario)
        }
        setTimeout(() => {
          if (errorEl) {
            errorEl.textContent = ''
            errorEl.style.color = ''
          }
          ocultarLogin()
        }, 900)
      } catch (e) {
        if (errorEl) errorEl.textContent = 'Error de conexi√≥n con el servidor'
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      try { cargarReporte(); } catch (e) {}
      inicializarAutocompletadoCliente();
      ['pago-efectivo','pago-tarjeta','pago-qr'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', () => {
            if (el.checked) {
              ['pago-efectivo','pago-tarjeta','pago-qr'].forEach(otherId => {
                if (otherId !== id) {
                  const other = document.getElementById(otherId);
                  if (other) other.checked = false;
                }
              });
            }
          });
        }
      });
      // Filtros del reporte
      const header = document.querySelector('.report-header');
      if (header) {
        const filtrosHTML = `
          <div class="report-filters">
            <button class="chip" data-metodo="todos">Todos</button>
            <button class="chip" data-metodo="efectivo">Efectivo</button>
            <button class="chip" data-metodo="tarjeta">Tarjeta</button>
            <button class="chip" data-metodo="qr">QR</button>
          </div>`;
        header.insertAdjacentHTML('beforeend', filtrosHTML);
        header.querySelectorAll('.chip').forEach(btn => {
          btn.addEventListener('click', () => {
            filtroMetodo = btn.getAttribute('data-metodo') || 'todos';
            header.querySelectorAll('.chip').forEach(b => b.classList.toggle('active', b === btn));
            actualizarUIReporte();
          });
        });
        const def = header.querySelector('.chip[data-metodo="todos"]');
        if (def) def.classList.add('active');
      }
      // setInterval(checkResetReporte, 60000); // Eliminado
      loadDbInfo().then(checkConexion);
      setInterval(checkConexion, 20000);
      const usuarioId = localStorage.getItem('USUARIO_ID')
      if (!usuarioId) {
        mostrarLogin()
      } else {
        ocultarLogin()
      }
      actualizarUserBar()
      solicitarConsecutivo().catch(() => {})
      ;['click','keydown','mousemove','touchstart'].forEach(ev => {
        document.addEventListener(ev, resetInactividad)
      })
      resetInactividad()
      cargarReporte()
    });
    function agregarVentaReporte(metodo) {
      // Ya no usamos localStorage local, recargamos desde BD
      setTimeout(() => {
        cargarReporte()
      }, 500)
    }
    const REPORTE_PASS = '79333587';
    
    let filtroPuntoVenta = 'ferreteria'; // Default

    function setFiltroPuntoVenta(pv) {
      filtroPuntoVenta = pv;
      const btnF = document.getElementById('tab-ferreteria');
      const btnB = document.getElementById('tab-bodega');
      if (btnF && btnB) {
        if (pv === 'ferreteria') {
          btnF.classList.add('active');
          btnB.classList.remove('active');
        } else {
          btnF.classList.remove('active');
          btnB.classList.add('active');
        }
      }
      actualizarUIReporte();
    }

    function actualizarUIReporte() {
      const cont = document.getElementById('reporte-lista');
      const sumEl = document.getElementById('reporte-suma');
      if (!cont || !sumEl) return;
      
      // Filtramos por punto de venta Y por m√©todo de pago
      const visibles = reporteVentas.filter(it => {
        const mismoPV = (it.pv || 'ferreteria') === filtroPuntoVenta;
        const mismoMetodo = filtroMetodo === 'todos' ? true : it.m === filtroMetodo;
        return mismoPV && mismoMetodo;
      });

      cont.innerHTML = visibles.map((it, i) => `
        <div class="report-item">
          <span>#${it.id || '?'} ‚Äî ${formatearPesos(it.v)} ‚Äî ${(it.m || '').toUpperCase()}</span>
          <button class="report-del" onclick="eliminarVentaBD(${it.id})">Eliminar</button>
        </div>
      `).join('');
      
      const sumaTotal = visibles.reduce((acc, it) => acc + (parseInt(it.v) || 0), 0);
      const sumaEf = visibles.filter(it => it.m === 'efectivo').reduce((acc, it) => acc + it.v, 0);
      const sumaTa = visibles.filter(it => it.m === 'tarjeta').reduce((acc, it) => acc + it.v, 0);
      const sumaQr = visibles.filter(it => it.m === 'qr').reduce((acc, it) => acc + it.v, 0);
      sumEl.innerHTML = `
        <div><strong>Total (${filtroPuntoVenta.toUpperCase()}):</strong> ${formatearPesos(sumaTotal)}</div>
        <div><strong>Efectivo:</strong> ${formatearPesos(sumaEf)}</div>
        <div><strong>Tarjeta:</strong> ${formatearPesos(sumaTa)}</div>
        <div><strong>QR:</strong> ${formatearPesos(sumaQr)}</div>
      `;
    }
    function toggleReportePanel() {
      const p = document.getElementById('report-panel');
      if (!p) return;
      p.classList.toggle('open');
      if (p.classList.contains('open')) {
        cargarReporte()
      }
    }
    async function eliminarVentaBD(idConsecutivo) {
      const rol = localStorage.getItem('USUARIO_ROL')
      console.log('Intentando eliminar venta:', idConsecutivo, 'Rol actual:', rol);
      
      if (!rol) {
        alert('No se detect√≥ rol de usuario. Por favor cierre sesi√≥n e ingrese nuevamente.')
        return
      }

      if (rol !== 'admin') {
        alert('Solo los usuarios administradores pueden eliminar ventas.')
        return
      }
      const confirmar = window.confirm('¬øEst√° seguro de eliminar la venta #' + idConsecutivo + '? Esta acci√≥n no se puede deshacer.')
      if (!confirmar) return

      try {
        const resp = await fetch(getApiBase() + '/api/venta/' + idConsecutivo, { method: 'DELETE' })
        if (resp.ok) {
          const data = await resp.json()
          if (data.ok) {
            alert('Venta eliminada correctamente')
            cargarReporte() // Recargar lista desde BD
            return
          }
        }
        alert('Error al eliminar la venta')
      } catch (e) {
        alert('Error de conexi√≥n al eliminar')
      }
    }
    function getSelectedMetodoPago() {
      const esEf = document.getElementById('pago-efectivo')?.checked;
      const esTa = document.getElementById('pago-tarjeta')?.checked;
      const esQr = document.getElementById('pago-qr')?.checked;
      if (esEf) return 'efectivo';
      if (esTa) return 'tarjeta';
      if (esQr) return 'qr';
      return null;
    }
    function obtenerTotalNumerico() {
      const totalText = document.getElementById('total-general')?.textContent || ''
      return parseInt(totalText.replace(/[^\d]/g, '')) || 0
    }
    function obtenerItemsBD() {
      const items = []
      tabla.querySelectorAll('tr').forEach(fila => {
        const cantTxt = fila.querySelector('.cant')?.innerText || ''
        const cant = parseInt(cantTxt.replace(/[^\d]/g, '')) || 0
        const celdaDesc = fila.cells[1];
        const desc = celdaDesc?.textContent.trim() || ''
        const idProd = celdaDesc?.dataset?.id || null;
        const vuTxt = fila.querySelector('.valor-u')?.innerText || ''
        const vu = parseInt(vuTxt.replace(/[^\d]/g, '')) || 0
        if (cant > 0 && desc) {
          items.push({
            id_producto: idProd,
            descripcion: desc,
            cantidad: cant,
            valor_unitario: vu,
            valor_total: cant * vu
          })
        }
      })
      return items
    }
    async function buscarClientesRemoto(termino) {
      try {
        const url = getApiBase() + '/api/clientes?q=' + encodeURIComponent(termino)
        const resp = await fetch(url)
        if (!resp.ok) return []
        const data = await resp.json()
        const lista = Array.isArray(data?.clientes) ? data.clientes : []
        return lista.map(c => ({
          id: c.id,
          nombre: c.nombre,
          nit_cc: c.nit_cc,
          telefono: c.telefono,
          direccion: c.direccion,
          tipo_cliente: c.tipo_cliente
        }))
      } catch {
        return []
      }
    }
    function renderDropdownClientes(clientes) {
      const dropdown = document.getElementById('autocomplete-dropdown')
      const input = document.getElementById('nombre-cliente')
      if (!dropdown) return
      dropdown.innerHTML = ''
      if (!clientes || clientes.length === 0) {
        dropdown.style.display = 'none'
        return
      }
      dropdown.style.display = 'block'
      if (input) {
        const rect = input.getBoundingClientRect()
        const offset = 12
        dropdown.style.position = 'fixed'
        dropdown.style.top = rect.bottom + 4 + 'px'
        dropdown.style.left = rect.left + offset + 'px'
        dropdown.style.right = ''
        dropdown.style.width = Math.max(rect.width - offset, 180) + 'px'
      } else {
        dropdown.style.position = 'absolute'
        dropdown.style.top = '100%'
        dropdown.style.left = '0'
        dropdown.style.right = '0'
        dropdown.style.width = '100%'
      }
      dropdown.style.background = '#ffffff'
      dropdown.style.border = '1px solid #d1d5db'
      dropdown.style.borderTop = 'none'
      dropdown.style.borderRadius = '0 0 4px 4px'
      dropdown.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1)'
      dropdown.style.zIndex = '9999'
      dropdown.style.maxHeight = '260px'
      dropdown.style.overflowY = 'auto'
      clientes.forEach(cliente => {
        const item = document.createElement('div')
        item.className = 'autocomplete-item'
        item.innerHTML = `
          <div class="cliente-nombre">ID: ${cliente.id} ¬∑ ${cliente.nombre}</div>
          <div class="cliente-info">NIT/CC: ${cliente.nit_cc || 'Sin NIT'}${cliente.telefono ? ' ¬∑ Tel: ' + cliente.telefono : ''}</div>
        `
        item.addEventListener('click', () => {
          seleccionarClienteAutocomplete(cliente)
        })
        dropdown.appendChild(item)
      })
    }
    function seleccionarClienteAutocomplete(cliente) {
      const input = document.getElementById('nombre-cliente')
      if (input) {
        input.value = `${cliente.id} - ${cliente.nit_cc || 'Sin NIT'} - ${cliente.nombre}`
      }
      clienteSeleccionado = cliente
      if (cliente && cliente.id) {
    localStorage.setItem('CLIENTE_ID', String(cliente.id))
  }

  // Si el formulario de transporte est√° activo, actualizar los datos
  if (document.getElementById('activar-transporte')?.checked) {
    document.getElementById('trans-nombre').value = cliente.nombre || '';
    document.getElementById('trans-direccion').value = cliente.direccion || '';
    document.getElementById('trans-telefono').value = cliente.telefono || '';
  }

  const dropdown = document.getElementById('autocomplete-dropdown')
      if (dropdown) {
        dropdown.style.display = 'none'
        dropdown.innerHTML = ''
      }
    }
    function inicializarAutocompletadoCliente() {
      const input = document.getElementById('nombre-cliente')
      const dropdown = document.getElementById('autocomplete-dropdown')
      if (!input || !dropdown) return
      input.addEventListener('input', () => {
        const term = input.value.trim()
        clienteSeleccionado = null
        localStorage.removeItem('CLIENTE_ID')
        if (clienteSearchTimer) {
          clearTimeout(clienteSearchTimer)
          clienteSearchTimer = null
        }
        if (term.length < 1) {
          dropdown.style.display = 'none'
          dropdown.innerHTML = ''
          return
        }
        clienteSearchTimer = setTimeout(async () => {
          const clientes = await buscarClientesRemoto(term)
          renderDropdownClientes(clientes)
        }, 250)
      })
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.cliente-container')) {
          dropdown.style.display = 'none'
          dropdown.innerHTML = ''
        }
      })
    }
    function getPuntoVenta() {
      const select = document.getElementById('select-punto-venta');
      if (select) return select.value;
      const esBodega = document.body.classList.contains('formato-bodega') || document.getElementById('contenido-factura')?.classList.contains('formato-bodega')
      return esBodega ? 'bodega' : 'ferreteria'
    }
    function actualizarPuntoVenta(valor) {
      const body = document.body;
      const contenido = document.getElementById('contenido-factura');
      if (valor === 'bodega') {
        body.classList.add('formato-bodega');
        if (contenido) contenido.classList.add('formato-bodega');
      } else {
        body.classList.remove('formato-bodega');
        if (contenido) contenido.classList.remove('formato-bodega');
      }
    }
    
    function getTipoPago() {
      const select = document.getElementById('select-tipo-pago')
      const val = select ? select.value : 'CONTADO'
      return val === 'CREDITO' ? 'CREDITO' : 'CONTADO'
    }
    function getIds() {
      const u = parseInt(localStorage.getItem('USUARIO_ID') || '1') || 1
      const c = parseInt(localStorage.getItem('CLIENTE_ID') || '1') || 1
      return { usuario_id: u, cliente_id: c }
    }
    let lastConsecutivo = null
    let clienteSeleccionado = null
    let clienteSearchTimer = null
    async function editarConsecutivo() {
      const actual = document.getElementById('numero-consecutivo').innerText;
      const nuevo = prompt("Ingrese el nuevo n√∫mero de consecutivo (4 d√≠gitos):", actual);
      
      if (nuevo === null) return; // Cancelado
      
      const num = parseInt(nuevo);
      if (isNaN(num) || num < 1000 || num > 9999) {
        alert("El consecutivo debe ser un n√∫mero de 4 d√≠gitos.");
        return;
      }
      
      try {
        const resp = await fetch(getApiBase() + '/api/check-consecutivo/' + num);
        
        if (resp.status === 404) {
            alert("‚ö†Ô∏è El servidor no se ha actualizado. Por favor reinicie 'server.js' en la terminal para activar esta funci√≥n.");
            return;
        }

        const data = await resp.json();
        
        if (data.exists) {
          alert("Este n√∫mero de consecutivo YA EXISTE en la base de datos. Por favor elija otro.");
          return;
        }
        
        // Si es v√°lido y no existe
        lastConsecutivo = num;
        document.getElementById('numero-consecutivo').innerText = num;
        
      } catch (e) {
        console.error(e);
        alert("Error al verificar el consecutivo.");
      }
    }

    async function solicitarConsecutivo() {
      const resp = await fetch(getApiBase() + '/api/consecutivo', { method: 'POST' })
      if (!resp.ok) throw new Error('no consecutivo')
      const data = await resp.json()
      const numero = data && (data.id_consecutivo ?? data.consecutivo ?? data.numero)
      if (!numero) throw new Error('respuesta sin consecutivo')
      lastConsecutivo = numero
      const el = document.getElementById('numero-consecutivo')
      if (el) el.textContent = numero
      return numero
    }
    async function guardarVentaBD(metodo) {
      const items = obtenerItemsBD()
      if (items.length === 0) return false
      const total = obtenerTotalNumerico()
      const clienteTexto = document.getElementById('nombre-cliente')?.value.trim() || ''
      const tipo_pago = getTipoPago()
      const { usuario_id, cliente_id } = getIds()
      if (tipo_pago === 'CREDITO') {
        if (!clienteSeleccionado || !clienteSeleccionado.id) {
          alert('No se puede financiar facturas a clientes no registrados en la base de datos')
          return false
        }
      }
      
      // Validar consecutivo actual antes de enviar
      let id_consecutivo = document.getElementById('numero-consecutivo').innerText.trim();
      id_consecutivo = parseInt(id_consecutivo);
      
      if (!id_consecutivo || isNaN(id_consecutivo) || id_consecutivo < 1000) {
          // Si no es v√°lido, intentar obtener uno nuevo
          try {
            id_consecutivo = await solicitarConsecutivo();
          } catch (e) {
            alert("No se pudo obtener un consecutivo v√°lido.");
            return false;
          }
      } else {
          // Validar que no exista ya (doble chequeo de seguridad)
          try {
            const check = await fetch(getApiBase() + '/api/check-consecutivo/' + id_consecutivo);
            const checkData = await check.json();
            if (checkData.exists) {
                alert(`El consecutivo ${id_consecutivo} YA EXISTE en la base de datos. Por favor ed√≠telo o genere uno nuevo.`);
                return false;
            }
          } catch (e) {
             console.error("Error validando consecutivo previo al guardado", e);
             // Permitimos continuar bajo riesgo o bloqueamos? Mejor bloquear para seguridad
             if(!confirm("No se pudo verificar si el consecutivo existe. ¬øDesea intentar guardarlo de todos modos?")) {
                 return false;
             }
          }
      }

      lastConsecutivo = id_consecutivo
      const payload = {
        id_consecutivo,
        usuario_id,
        cliente_id,
        total,
        tipo_pago,
        forma_pago: (metodo || '').toUpperCase(),
        punto_venta: getPuntoVenta(),
        items,
        cliente_nombre: clienteTexto
      }
      const resp = await fetch(getApiBase() + '/api/venta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      
      if (resp.status === 409) { // Conflicto / Duplicado
          const errData = await resp.json();
          alert(`Error: El consecutivo ${id_consecutivo} ya fue registrado por otra venta hace un instante. Por favor intente de nuevo con otro n√∫mero.`);
          await solicitarConsecutivo(); // Generar uno nuevo autom√°ticamente
          return false;
      }

      if (!resp.ok) return false
      const data = await resp.json()
      return !!data?.ok
    }
// Seleccionar todo el contenido de la celda activa al presionar Shift
tabla.addEventListener('keydown', (e) => {
  if (e.key === 'Shift' && celdaActiva) {
    const range = document.createRange();
    range.selectNodeContents(celdaActiva);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }
});
// Actualizar la fecha y hora actual en el div
function actualizarFechaHora() {
  const ahora = new Date();
  const opciones = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
  const fechaFormateada = ahora.toLocaleString('es-CO', opciones).replace('.', '');
  document.getElementById('fecha-actual').innerHTML = `<strong>FECHA:</strong> ${fechaFormateada}`;
}

// Llamar la funci√≥n al cargar la p√°gina
actualizarFechaHora();


  </script>
    <!-- Dashboard Programaci√≥n -->
  <div id="dashboard-programacion">
    <h3>Pedidos Programados</h3>
    <div id="lista-pedidos"></div>
    <button class="btn-despachado" onclick="despacharPedido()">DESPACHADO</button>
  </div>

  <!-- Modal Programaci√≥n -->
  <div id="modal-programacion" class="modal-programacion">
    <div class="modal-content">
      <h3>Programar Entrega</h3>
      <div class="form-group">
        <label>Fecha:</label>
        <input type="date" id="prog-fecha">
      </div>
      <div class="form-group">
        <label>Hora (8am - 6pm):</label>
        <select id="prog-hora" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="08:00">08:00 AM</option>
            <option value="09:00">09:00 AM</option>
            <option value="10:00">10:00 AM</option>
            <option value="11:00">11:00 AM</option>
            <option value="12:00">12:00 PM</option>
            <option value="13:00">01:00 PM</option>
            <option value="14:00">02:00 PM</option>
            <option value="15:00">03:00 PM</option>
            <option value="16:00">04:00 PM</option>
            <option value="17:00">05:00 PM</option>
            <option value="18:00">06:00 PM</option>
        </select>
      </div>
      <div style="text-align: center; margin-top: 20px;">
          <button class="btn-guardar-prog" onclick="guardarProgramacion()">Guardar</button>
          <button class="btn-cancelar-prog" onclick="cerrarModalProgramacion()">Cancelar</button>
      </div>
    </div>
  </div>

<script>
// --- L√ìGICA DE PROGRAMACI√ìN DE PEDIDOS ---

let pedidoSeleccionadoId = null;

function initDashboard() {
  renderDashboard();
}

function getPedidosProgramados() {
  const pedidos = localStorage.getItem('PEDIDOS_PROGRAMADOS');
  return pedidos ? JSON.parse(pedidos) : [];
}

function savePedidosProgramados(pedidos) {
  localStorage.setItem('PEDIDOS_PROGRAMADOS', JSON.stringify(pedidos));
  renderDashboard();
}

function renderDashboard() {
  const lista = document.getElementById('lista-pedidos');
  if (!lista) return;
  
  const pedidos = getPedidosProgramados();
  // Ordenar por fecha/hora
  pedidos.sort((a, b) => {
    return new Date(a.fecha + ' ' + a.hora) - new Date(b.fecha + ' ' + b.hora);
  });

  lista.innerHTML = '';
  
  if (pedidos.length === 0) {
    lista.innerHTML = '<div style="text-align:center; color:#777; padding:10px;">No hay pedidos programados</div>';
    return;
  }

  pedidos.forEach(p => {
    const item = document.createElement('div');
    item.className = 'pedido-item';
    if (pedidoSeleccionadoId === p.id) item.classList.add('selected');
    
    // Formato fecha amigable
    const dateObj = new Date(p.fecha + 'T' + p.hora);
    const fechaStr = dateObj.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
    
    // Formato hora AM/PM simple
    let horaShow = p.hora;
    try {
        const [hh, mm] = p.hora.split(':');
        const hVal = parseInt(hh);
        const ampm = hVal >= 12 ? 'PM' : 'AM';
        const h12 = hVal % 12 || 12;
        horaShow = `${h12} ${ampm}`;
    } catch(e) {}

    item.innerHTML = `
      <div class="pedido-info"><strong>${p.consecutivo ? 'REM ' + p.consecutivo : 'ID: ' + p.id.substr(0,4)}</strong></div>
      <div class="pedido-info">${p.cliente_nombre || 'Cliente General'}</div>
      <div class="pedido-info" style="color:#555;">üìÖ ${fechaStr} ‚è∞ ${horaShow}</div>
      <div class="pedido-status">${p.estado}</div>
    `;
    
    item.onclick = () => selectPedidoDashboard(p.id, item);
    item.ondblclick = () => abrirPdfPedido(p.id);
    
    lista.appendChild(item);
  });
}

function selectPedidoDashboard(id, elem) {
  pedidoSeleccionadoId = id;
  document.querySelectorAll('.pedido-item').forEach(el => el.classList.remove('selected'));
  elem.classList.add('selected');
}

async function abrirModalProgramacion() {
   // Descargar PDF autom√°ticamente antes de abrir el modal
   try {
     await descargarPDF(true); // true = modo silencioso
   } catch (error) {
     console.error("Error generando PDF autom√°tico:", error);
   }

   document.getElementById('modal-programacion').style.display = 'flex';
   const now = new Date();
   document.getElementById('prog-fecha').valueAsDate = now;
 }

function cerrarModalProgramacion() {
  document.getElementById('modal-programacion').style.display = 'none';
}

function guardarProgramacion() {
  const fecha = document.getElementById('prog-fecha').value;
  const hora = document.getElementById('prog-hora').value;
  
  if (!fecha || !hora) {
    alert("Por favor seleccione fecha y hora");
    return;
  }

  // Validaci√≥n de transporte obligatorio
  const transporteActivo = document.getElementById('activar-transporte').checked;
  if (!transporteActivo) {
    alert("‚ö†Ô∏è Es OBLIGATORIO habilitar la opci√≥n 'A√±adir transporte' para programar un pedido.");
    return;
  }

  // Validaci√≥n de disponibilidad
  const pedidos = getPedidosProgramados();
  const ocupado = pedidos.some(p => p.fecha === fecha && p.hora === hora);
  
  if (ocupado) {
    alert("‚ö†Ô∏è Esa fecha y hora ya est√°n ocupadas por otro pedido. Por favor seleccione otro horario.");
    return;
  }

  // Validaci√≥n: Solo horas en punto (Aunque el select lo fuerza, doble check por seguridad)
  const [h, m] = hora.split(':');
  if (m !== '00') {
      alert("Solo se permiten horas en punto (Ej: 8:00, 9:00).");
      return;
  }
  const hNum = parseInt(h);
  if (hNum < 8 || hNum > 18) {
      alert("El horario permitido es de 8:00 AM a 6:00 PM.");
      return;
  }

  // Recopilar datos del pedido actual
  const items = obtenerItemsBD(); 
  if (items.length === 0) {
    alert("No hay productos en la tabla para programar.");
    return;
  }
  
  const clienteNombre = document.getElementById('nombre-cliente').value;
  const consecutivo = document.getElementById('numero-consecutivo').innerText;
  
  const nuevoPedido = {
    id: Date.now().toString(),
    consecutivo: (consecutivo !== '----') ? consecutivo : null,
    cliente_nombre: clienteNombre,
    cliente_data: clienteSeleccionado,
    items: items,
    total: obtenerTotalNumerico(),
    fecha: fecha,
    hora: hora,
    estado: 'PROGRAMADO',
    transporte: {
       activo: document.getElementById('activar-transporte').checked,
       nombre: document.getElementById('trans-nombre').value,
       direccion: document.getElementById('trans-direccion').value,
       telefono: document.getElementById('trans-telefono').value,
       costo: document.getElementById('trans-costo').value
    },
    tipo_pago: getTipoPago(),
    metodo_pago: getSelectedMetodoPago(),
    punto_venta: getPuntoVenta()
  };
  
  pedidos.push(nuevoPedido);
  savePedidosProgramados(pedidos);
  
  alert("Pedido programado correctamente.");
  cerrarModalProgramacion();
}

function abrirPdfPedido(id) {
  const pedidos = getPedidosProgramados();
  const pedido = pedidos.find(p => p.id === id);
  if (!pedido) return;

  const pv = pedido.punto_venta || 'ferreteria'; 
  const filename = (pedido.consecutivo) ? `${pedido.consecutivo}_${pv}.pdf` : `remision_${pv}.pdf`;
  const rutaWindows = `G:\\Mi unidad\\FERREDISTRIBUCIONES ALUMAS SAS\\bodega\\${filename}`;

  // Mensaje directo: Ruta y opci√≥n de copiar
  if (confirm(`Ubicaci√≥n del archivo:\n${rutaWindows}\n\n¬øDesea copiar la ruta al portapapeles?`)) {
      navigator.clipboard.writeText(rutaWindows).then(() => {
          // Opcional: Feedback breve o silencioso
          // alert("Ruta copiada."); 
      }).catch(err => {
          prompt("Copie la ruta manualmente:", rutaWindows);
      });
  }
}

function cargarPedidoProgramado(id) {
  const pedidos = getPedidosProgramados();
  const pedido = pedidos.find(p => p.id === id);
  
  if (!pedido) return;
  
  if (!confirm("‚ö†Ô∏è Cargar este pedido reemplazar√° lo que tenga en pantalla. ¬øDesea continuar?")) {
    return;
  }
  
  limpiarTabla();
  
  // Restaurar Cliente
  const inputCliente = document.getElementById('nombre-cliente');
  inputCliente.value = pedido.cliente_nombre || '';
  clienteSeleccionado = pedido.cliente_data;
  if (clienteSeleccionado && clienteSeleccionado.id) {
     localStorage.setItem('CLIENTE_ID', String(clienteSeleccionado.id));
  }
  
  // Restaurar Consecutivo
  if (pedido.consecutivo) {
      document.getElementById('numero-consecutivo').innerText = pedido.consecutivo;
      lastConsecutivo = pedido.consecutivo;
  }
  
  // Restaurar Items
  const tbody = document.getElementById('tabla-productos');
  tbody.innerHTML = ''; 
  
  pedido.items.forEach(item => {
     const tr = document.createElement('tr');
     tr.innerHTML = `
        <td class="cant" contenteditable="true">${item.cantidad}</td>
        <td contenteditable="true" data-id="${item.id_producto || ''}">${item.descripcion}</td>
        <td class="valor-u" contenteditable="true">${formatearPesos(item.valor_unitario)}</td>
        <td class="valor-t">${formatearPesos(item.valor_total)}</td>
     `;
     tbody.appendChild(tr);
  });
  
  while (tbody.children.length < 7) {
     agregarFila();
  }
  
  // Restaurar Transporte
  if (pedido.transporte && pedido.transporte.activo) {
      document.getElementById('activar-transporte').checked = true;
      toggleTransporte();
      document.getElementById('trans-nombre').value = pedido.transporte.nombre || '';
      document.getElementById('trans-direccion').value = pedido.transporte.direccion || '';
      document.getElementById('trans-telefono').value = pedido.transporte.telefono || '';
      document.getElementById('trans-costo').value = pedido.transporte.costo || '';
  } else {
      document.getElementById('activar-transporte').checked = false;
      toggleTransporte();
  }
  
  actualizarTotales();
  // alert("Pedido cargado: " + (pedido.cliente_nombre || 'Sin nombre'));
}

function despacharPedido() {
  if (!pedidoSeleccionadoId) {
    alert("Seleccione un pedido del tablero para despachar.");
    return;
  }
  
  if (!confirm("¬øMarcar pedido como DESPACHADO? Se eliminar√° del tablero.")) return;
  
  let pedidos = getPedidosProgramados();
  pedidos = pedidos.filter(p => p.id !== pedidoSeleccionadoId);
  savePedidosProgramados(pedidos);
  pedidoSeleccionadoId = null;
}

document.addEventListener('DOMContentLoaded', () => {
    initDashboard();
});
</script>
</body>
</html>
