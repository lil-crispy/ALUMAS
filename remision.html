<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remisi√≥n ALUMAS</title>
  <link rel="icon" type="image/svg+xml" href="./img/LOGO3.webp" />

  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="./css/remision.css?v=20251209">

  <!-- Cargar fuentes personalizadas -->
  <style>
    @font-face {
      font-family: 'Bauhaus';
      src: local('Bauhaus 93'), local('Bauhaus93');
    }

    .valor-u[contenteditable="true"] {
      direction: ltr;
      unicode-bidi: plaintext;
      text-align: left;
    }

    #form-transporte {
      display: none;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 10px;
      background-color: #f9f9f9;
    }

    .campo-form {
      margin-bottom: 10px;
    }

    #info-transporte {
      margin-top: 10px;
      font-size: 14px;
    }

    .checkbox-transporte {
      margin: 10px 0;
    }
  </style>

  <!-- Librer√≠as para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    window.jsPDF = window.jspdf.jsPDF;
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>

  <div id="login-overlay" class="login-overlay">
    <div class="login-box">
      <img src="./img/logo5.webp" alt="ALUMAS" class="login-logo">
      <h2>Acceso al sistema</h2>
      <input type="text" id="login-usuario" placeholder="Usuario">
      <input type="password" id="login-contrasena" placeholder="Contrase√±a">
      <button onclick="realizarLogin()">Ingresar</button>
      <div id="login-error" class="login-error"></div>
    </div>
  </div>

  <div id="conn-status" class="conn-status">Comprobando conexi√≥n‚Ä¶</div>
  <div id="user-bar" class="user-bar">
    <span id="user-name-prefix">USUARIO:</span>
    <span id="user-name"></span>
    <button type="button" id="logout-btn" onclick="logoutUsuario()">Cerrar sesi√≥n</button>
  </div>
  <div class="conn-spacer"></div>

  <div class="report-toggle" onclick="toggleReportePanel()">Reporte ‚ñº</div>

  <div class="contenedor-principal" id="contenido-factura">
    <div class="encabezado">
      <div>
        <div class="titulo"></div>
        <img src="./img/LOGO4.webp" alt="Logo ALUMAS" style="max-width: 300px; display: block; margin: 0 auto;">
      </div>
    </div>

    <div class="consecutivo-display" id="consecutivo-display">
      CONSECUTIVO: <span id="numero-consecutivo">----</span>
    </div>

    <div class="info">
      <p id="fecha-actual"><strong>FECHA:</strong></p>
      <p>
        <strong>CLIENTE:</strong>
        <span class="cliente-container">
          <input type="text" id="nombre-cliente" class="cliente-input" placeholder="Buscar cliente por nombre o NIT...">
          <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
        </span>
      </p>
      <p><strong>NIT:</strong> 901797743-2</p>
      <p><strong>ATENCI√ìN AL CLIENTE:</strong> 3015827791</p>
      <p><strong>CONSULTAR ENV√çOS:</strong> 3197245235</p>
      <p class="nota-whatsapp"><strong>Por seguridad, solo atendemos llamadas y mensajes v√≠a WhatsApp.</strong></p>
      <p><strong>DIR:</strong> CALLE 139#109-46</p>
      <div id="info-transporte"></div>
    </div>

    <div class="checkbox-transporte">
      <input type="checkbox" id="activar-transporte" onchange="toggleTransporte()"> <label for="activar-transporte">A√±adir transporte</label>
    </div>
    <div class="metodos-pago">
      <label><input type="checkbox" id="pago-efectivo"> Efectivo</label>
      <label><input type="checkbox" id="pago-tarjeta"> Tarjeta</label>
      <label><input type="checkbox" id="pago-qr"> QR</label>
    </div>

    <div class="tipo-pago-selector" style="margin-top: 10px; margin-bottom: 10px;">
      <label for="select-tipo-pago"><strong>Tipo de pago:</strong></label>
      <select id="select-tipo-pago" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
        <option value="CONTADO" selected>Contado</option>
        <option value="CREDITO">Cr√©dito</option>
      </select>
    </div>

    <div class="punto-venta-selector" style="margin-top: 10px; margin-bottom: 10px;">
      <label for="select-punto-venta"><strong>Punto de Venta:</strong></label>
      <select id="select-punto-venta" onchange="actualizarPuntoVenta(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
        <option value="ferreteria">Ferreter√≠a</option>
        <option value="bodega">Bodega</option>
      </select>
    </div>

    <div id="form-transporte">
      <div class="campo-form">
        <label>Nombre del cliente:</label>
        <input type="text" id="trans-nombre">
      </div>
      <div class="campo-form">
        <label>Direcci√≥n de env√≠o:</label>
        <input type="text" id="trans-direccion">
      </div>
      <div class="campo-form">
        <label>Tel√©fono:</label>
        <input type="text" id="trans-telefono">
      </div>
      <div class="campo-form">
        <label>Costo del transporte:</label>
        <input type="number" id="trans-costo">
      </div>
      <button onclick="guardarTransporte()">Guardar transporte</button>
    </div>

    <div class="contenedor-tabla">
      <div class="acciones-tabla">
        <button onclick="agregarFila()">‚ûï</button>
        <button onclick="eliminarFila()">‚ûñ</button>
        <button onclick="limpiarTabla()">üßπ Limpiar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th class="col-cant">CANT</th>
            <th class="col-desc">DESCRIPCI√ìN</th>
            <th class="col-valor">VALOR U</th>
            <th class="col-valor">VALOR T</th>
   
          </tr>
        </thead>
        <tbody id="tabla-productos">
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
          <tr><td contenteditable="true" class="cant"></td><td contenteditable="true"></td><td contenteditable="true" class="valor-u"></td><td class="valor-t"></td></tr>
        </tbody>
      </table>
    </div>
  
    <p class="total" id="total-general">TOTAL: $ 0</p>
    

    <img src="./img/LOGO3.webp" alt="Logo ALUMAS" class="logo-grande">

    <div class="mensaje">
      <p><strong>***GRACIAS POR SU COMPRA***</strong></p>
      <small>SI NECESITA FACTURA ELECTR√ìNICA ENVIAR ESTA REMISI√ìN Y EL RUT AL 3015827791</small>
      <small>EL USO DE LA FACTURA ES INDISPENSABLE PARA CUALQUIER TIPO DE DEVOLUCI√ìN.</small>
      <small>NO SE REMBOLSA EL DINERO EN CASO QUE EL PRODUCTO NO CUMPLA CON EL FUNCIONAMIENTO.</small>
      <small>SE PUEDE CAMBIAR POR OTRO DEL MISMO VALOR SIEMPRE Y CUANDO EST√â EN BUEN ESTADO.</small>
      <div style="text-align: right; margin-top: 40px;">
        <img src="./img/firma.webp" alt="Firma" style="width:150px;filter:brightness(0) contrast(1000);-webkit-print-color-adjust:exact;print-color-adjust:exact;mix-blend-mode:multiply;">

      </div>
    </div>

    <div class="boton-imprimir">
      <button class="btn btn-cotizar" onclick="imprimirCotizacion()">Cotizar</button>
      <button class="btn btn-vender" onclick="imprimirVenta()">Vender</button>
      <button class="btn btn-pdf" onclick="descargarPDF()">Descargar PDF</button>
    </div>
    <div id="report-panel" class="report-panel">
      <div class="report-header">
        <span>Reporte diario</span>
        <button class="report-close" onclick="toggleReportePanel()">√ó</button>
      </div>
      <div id="reporte-lista" class="report-list"></div>
      <div id="reporte-suma" class="report-total"></div>
    </div>
  </div>

  <script>
    const tabla = document.getElementById('tabla-productos');
    let celdaActiva = null;
  
    function formatearPesos(valor) {
      const numero = parseInt(valor);
      if (isNaN(numero)) return '$ 0';
      return '$ ' + numero.toLocaleString('es-CO');
    }
  
    function actualizarTotales() {
      let totalGeneral = 0;
  
      tabla.querySelectorAll('tr').forEach(fila => {
        const cant = parseInt(fila.querySelector('.cant')?.innerText || 0);
        const valorUCell = fila.querySelector('.valor-u');
        const valorUTxt = valorUCell?.innerText.replace(/[^\d]/g, '') || '0';
        const valorU = parseInt(valorUTxt);
  
        const totalFila = cant * valorU;
        const totalCelda = fila.querySelector('.valor-t');
        if (totalCelda) totalCelda.innerText = formatearPesos(totalFila);
  
        if (!isNaN(totalFila)) totalGeneral += totalFila;
      });
  
      document.getElementById('total-general').innerText = 'TOTAL: ' + formatearPesos(totalGeneral);
    }
  
    tabla.addEventListener('input', (e) => {
      const target = e.target;
      if (target.classList.contains('cant') || target.classList.contains('valor-u')) {
        actualizarTotales();
      }
    });
  
    function agregarFila() {
      const nuevaFila = document.createElement('tr');
      nuevaFila.innerHTML = `
        <td class="cant"></td>
        <td></td>
        <td class="valor-u"></td>
        <td class="valor-t"></td>
      `;
      tabla.appendChild(nuevaFila);
      actualizarFechaHora();
      actualizarTotales();
    }
  
    function eliminarFila() {
      const filas = tabla.querySelectorAll('tr');
      if (filas.length > 1) {
        tabla.removeChild(filas[filas.length - 1]);
        actualizarTotales();
        actualizarFechaHora();
      }
    }
  
    function limpiarTabla() {
      tabla.querySelectorAll('tr').forEach(fila => {
        fila.querySelectorAll('td').forEach(celda => {
          if (!celda.classList.contains('valor-t')) {
            celda.textContent = '';
          } else {
            celda.innerText = '';
          }
          actualizarFechaHora();
        });
      });
  
      actualizarTotales();
  
      // Limpiar transporte
      document.getElementById('trans-nombre').value = '';
      document.getElementById('trans-direccion').value = '';
      document.getElementById('trans-telefono').value = '';
      document.getElementById('trans-costo').value = '';
      document.getElementById('nombre-cliente').innerText = '';
      document.getElementById('info-transporte').innerHTML = '';
  
      tabla.querySelectorAll('tr').forEach(fila => {
        const descripcion = fila.cells[1]?.textContent.trim();
        if (descripcion === 'TRANSPORTE') {
          tabla.removeChild(fila);
        }
      });
    }
  
    function descargarPDF() {
      const contenido = document.getElementById("contenido-factura");
      html2canvas(contenido, { scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const scaleFactor = 0.6;
        const imgWidth = pageWidth * scaleFactor;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        const x = (pageWidth - imgWidth) / 2;
        const y = (pageHeight - imgHeight) / 2;
  
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        const pv = getPuntoVenta()
        const nombre = (lastConsecutivo ? `${lastConsecutivo}_${pv}.pdf` : `remision_${pv}.pdf`)
        pdf.save(nombre);
      });
    }
  
  function toggleTransporte() {
  const form = document.getElementById('form-transporte');
  const mensajeTransporte = document.getElementById('mensaje-transporte');

  form.style.display = document.getElementById('activar-transporte').checked ? 'block' : 'none';

  if (document.getElementById('activar-transporte').checked) {
    // Si hay un cliente seleccionado, rellenar datos autom√°ticamente
    if (clienteSeleccionado) {
      document.getElementById('trans-nombre').value = clienteSeleccionado.nombre || '';
      document.getElementById('trans-direccion').value = clienteSeleccionado.direccion || '';
      document.getElementById('trans-telefono').value = clienteSeleccionado.telefono || '';
    }

    if (!mensajeTransporte) {
      const mensaje = document.createElement('div');
      mensaje.id = 'mensaje-transporte';
      mensaje.innerHTML = `
        <p style="font-size: 22px; font-weight: bold; text-align: center; margin-top: 40px;">
          IMPORTANTE: TODO ENV√çO O DOMICILIO SE ENTREGA HASTA DONDE TENGA ACCESO EL VEH√çCULO DE TRANSPORTE. 
          EL CONDUCTOR O TRANSPORTADOR NO EST√Å AUTORIZADO A MANIPULAR LA MERCANC√çA M√ÅS ALL√Å DEL PRIMER PISO. 
          EN CASO DE HACER CASO OMISO A ESTA INSTRUCCI√ìN, EL TRABAJADOR PUEDE SER SANCIONADO POR LA EMPRESA.
        </p>
      `;
      const mensajeDiv = document.querySelector('.mensaje');
      mensajeDiv.parentNode.insertBefore(mensaje, mensajeDiv);
    }
  } else {
    if (mensajeTransporte) {
      mensajeTransporte.remove();
    }
  }
}

  
    function guardarTransporte() {
      const nombre = document.getElementById('trans-nombre').value;
      const direccion = document.getElementById('trans-direccion').value;
      const telefono = document.getElementById('trans-telefono').value;
      const costo = parseInt(document.getElementById('trans-costo').value) || 0;
  
      document.getElementById('nombre-cliente').innerText = nombre;
      document.getElementById('info-transporte').innerHTML = ``;
  
      const fila = document.createElement('tr');
      fila.innerHTML = `
        <td class="cant">1</td>
        <td>TRANSPORTE</td>
        <td class="valor-u">${costo}</td>
        <td class="valor-t">${formatearPesos(costo)}</td>
      `;
      tabla.appendChild(fila);
      actualizarTotales();
    }
  
    tabla.addEventListener('click', (e) => {
      const celda = e.target.closest('td');
      if (!celda || celda.classList.contains('valor-t')) return;
      celda.setAttribute('contenteditable', 'true');
      celda.focus();
      celdaActiva = celda;
    });
  
    tabla.addEventListener('dblclick', (e) => {
      const celda = e.target.closest('td');
      if (celda && !celda.classList.contains('valor-t')) {
        celda.setAttribute('contenteditable', 'true');
        celda.focus();
      }
    });
  
    tabla.addEventListener('keydown', (e) => {
      if (!celdaActiva) return;
  
      const fila = celdaActiva.parentElement;
      const columnas = Array.from(fila.children);
      const colIndex = columnas.indexOf(celdaActiva);
      let nuevaCelda;
  
      switch (e.key) {
        case 'ArrowRight':
          nuevaCelda = fila.children[colIndex + 1];
          break;
        case 'ArrowLeft':
          nuevaCelda = fila.children[colIndex - 1];
          break;
        case 'ArrowDown':
          const filaAbajo = fila.nextElementSibling;
          if (filaAbajo) nuevaCelda = filaAbajo.children[colIndex];
          break;
        case 'ArrowUp':
          const filaArriba = fila.previousElementSibling;
          if (filaArriba) nuevaCelda = filaArriba.children[colIndex];
          break;
        case 'Enter':
          e.preventDefault();
          const siguienteFila = fila.nextElementSibling;
          if (siguienteFila) nuevaCelda = siguienteFila.children[colIndex];
          break;
      }
  
      if (nuevaCelda && !nuevaCelda.classList.contains('valor-t')) {
        nuevaCelda.setAttribute('contenteditable', 'true');
        nuevaCelda.focus();
        celdaActiva = nuevaCelda;
      }
    });
  
    tabla.addEventListener('blur', (e) => {
      const celda = e.target.closest('td');
      if (celda && !celda.classList.contains('valor-t')) {
        celda.removeAttribute('contenteditable');
      }
    }, true);
    let originalMensajeHTML = '';
    document.addEventListener('DOMContentLoaded', () => {
      const mensajeDiv = document.querySelector('.mensaje');
      originalMensajeHTML = mensajeDiv ? mensajeDiv.innerHTML : '';
    });

    function aplicarCotizacionUI() {
      const mensajeDiv = document.querySelector('.mensaje');
      if (mensajeDiv) {
        mensajeDiv.innerHTML = `
          <p style="font-size: 22px; font-weight: bold; text-align: center; margin-top: 40px;">
            COTIZACI√ìN - NO V√ÅLIDO COMO COMPROBANTE DE COMPRA
          </p>
        `;
      }
      document.querySelectorAll('.logo-grande').forEach(logo => logo.style.display = 'none');
    }

    function aplicarVentaUI() {
      const mensajeDiv = document.querySelector('.mensaje');
      if (mensajeDiv && originalMensajeHTML) {
        mensajeDiv.innerHTML = originalMensajeHTML;
      }
      document.querySelectorAll('.logo-grande').forEach(logo => logo.style.display = 'block');
    }

    function imprimirCotizacion() {
      aplicarCotizacionUI();
      window.print();
    }

    async function imprimirVenta() {
      const tipo = getTipoPago();
      const metodo = getSelectedMetodoPago();
      if (tipo !== 'CREDITO' && !metodo) {
        alert('Seleccione un m√©todo de pago (Efectivo, Tarjeta o QR)');
        return;
      }
      aplicarVentaUI();
      let ok = false
      try {
        ok = await guardarVentaBD(metodo);
      } catch (e) {
        alert('Error guardando la venta');
        return;
      }
      if (!ok) {
        alert('La venta no se pudo guardar. Intente de nuevo.');
        return;
      }
      const mensaje = lastConsecutivo
        ? 'La venta se guard√≥ correctamente con consecutivo ' + lastConsecutivo + '. ¬øDesea imprimir la remisi√≥n?'
        : 'La venta se guard√≥ correctamente. ¬øDesea imprimir la remisi√≥n?';
      const confirmar = window.confirm(mensaje);
      if (confirmar) {
        const metodoReporte = metodo || (tipo === 'CREDITO' ? 'credito' : null);
        if (metodoReporte) agregarVentaReporte(metodoReporte);
        window.print();
      }
      window.location.reload();
    }

    window.addEventListener('afterprint', () => {
      aplicarVentaUI();
      ['pago-efectivo','pago-tarjeta','pago-qr'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = false;
      });
    });

    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    });
    let dbHost = null
    function getApiBase() {
      const qs = new URLSearchParams(window.location.search)
      const manual = qs.get('api_base') || localStorage.getItem('API_BASE')
      if (manual) return manual
      return window.location.origin
    }
    async function loadDbInfo() {
      try {
        const r = await fetch(getApiBase() + '/api/db-info')
        const data = await r.json()
        dbHost = data?.host || null
      } catch {}
    }
    async function checkConexion() {
      const el = document.getElementById('conn-status')
      try {
        const c = new AbortController()
        const t = setTimeout(() => c.abort(), 4000)
        const r = await fetch(getApiBase() + '/api/db-ping', { signal: c.signal })
        clearTimeout(t)
        const data = await r.json()
        const ok = !!data?.ok
        el.classList.toggle('conn-ok', ok)
        el.classList.toggle('conn-bad', !ok)
        const hostTxt = dbHost ? ` ${dbHost}` : ''
        el.textContent = ok ? `Conexi√≥n a BD${hostTxt} ‚úî` : `Conexi√≥n a BD${hostTxt} ‚úñ`
      } catch (e) {
        el.classList.add('conn-bad')
        el.classList.remove('conn-ok')
        const hostTxt = dbHost ? ` ${dbHost}` : ''
        el.textContent = `Conexi√≥n a BD${hostTxt} ‚úñ`
      }
    }
    let reporteVentas = [];
    let filtroMetodo = 'todos';
    // function checkResetReporte() { ... } eliminada
    async function cargarReporte() {
      try {
        const resp = await fetch(getApiBase() + '/api/reporte-ventas')
        if (resp.ok) {
          const data = await resp.json()
          if (data.ok && Array.isArray(data.ventas)) {
            reporteVentas = data.ventas.map(v => ({
              id: v.id_consecutivo,
              v: parseInt(v.total) || 0,
              m: (v.forma_pago || 'desconocido').toLowerCase(),
              fecha: v.fecha
            }))
            actualizarUIReporte()
            return
          }
        }
      } catch (e) {
        console.error('Error cargando reporte BD', e)
      }
      // Fallback a localStorage si falla la BD (opcional, pero mejor usar solo BD como pidi√≥ el usuario)
      reporteVentas = []
      actualizarUIReporte()
    }
    function mostrarLogin() {
      const overlay = document.getElementById('login-overlay')
      if (overlay) overlay.style.display = 'flex'
      document.body.classList.add('login-active')
    }
    function ocultarLogin() {
      const overlay = document.getElementById('login-overlay')
      if (overlay) overlay.style.display = 'none'
      document.body.classList.remove('login-active')
    }
    function actualizarUserBar() {
      const bar = document.getElementById('user-bar')
      const nameEl = document.getElementById('user-name')
      if (!bar || !nameEl) return
      const nombre = localStorage.getItem('USUARIO_NOMBRE') || ''
      if (nombre) {
        nameEl.textContent = nombre
        bar.style.display = 'flex'
      } else {
        nameEl.textContent = ''
        bar.style.display = 'none'
      }
    }
    function logoutUsuario() {
      localStorage.removeItem('USUARIO_ID')
      localStorage.removeItem('USUARIO_NOMBRE')
      localStorage.removeItem('USUARIO_ROL')
      actualizarUserBar()
      mostrarLogin()
    }
    let inactivityTimer = null
    function resetInactividad() {
      if (inactivityTimer) clearTimeout(inactivityTimer)
      inactivityTimer = setTimeout(() => {
        const usuarioId = localStorage.getItem('USUARIO_ID')
        if (usuarioId) {
          logoutUsuario()
          alert('La sesi√≥n se cerr√≥ por inactividad')
        }
      }, 30 * 60 * 1000)
    }
    async function realizarLogin() {
      const usuario = document.getElementById('login-usuario')?.value.trim() || ''
      const contrasena = document.getElementById('login-contrasena')?.value || ''
      const errorEl = document.getElementById('login-error')
      if (errorEl) {
        errorEl.textContent = ''
        errorEl.style.color = ''
      }
      if (!usuario || !contrasena) {
        if (errorEl) errorEl.textContent = 'Ingrese usuario y contrase√±a'
        return
      }
      try {
        const resp = await fetch(getApiBase() + '/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario, contrasena })
        })
        if (!resp.ok) {
          if (errorEl) errorEl.textContent = 'Credenciales inv√°lidas'
          return
        }
        const data = await resp.json()
        if (!data?.ok || !data?.usuario_id) {
          if (errorEl) errorEl.textContent = 'Credenciales inv√°lidas'
          return
        }
        localStorage.setItem('USUARIO_ID', String(data.usuario_id))
        if (data.usuario) localStorage.setItem('USUARIO_NOMBRE', data.usuario)
        localStorage.setItem('USUARIO_ROL', data.rol || 'vendedor')
        actualizarUserBar()
        if (errorEl) {
          errorEl.style.color = '#16a34a'
          errorEl.textContent = 'BIENVENIDO ' + (data.usuario || usuario)
        }
        setTimeout(() => {
          if (errorEl) {
            errorEl.textContent = ''
            errorEl.style.color = ''
          }
          ocultarLogin()
        }, 900)
      } catch (e) {
        if (errorEl) errorEl.textContent = 'Error de conexi√≥n con el servidor'
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      try { cargarReporte(); } catch (e) {}
      inicializarAutocompletadoCliente();
      ['pago-efectivo','pago-tarjeta','pago-qr'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', () => {
            if (el.checked) {
              ['pago-efectivo','pago-tarjeta','pago-qr'].forEach(otherId => {
                if (otherId !== id) {
                  const other = document.getElementById(otherId);
                  if (other) other.checked = false;
                }
              });
            }
          });
        }
      });
      // Filtros del reporte
      const header = document.querySelector('.report-header');
      if (header) {
        const filtrosHTML = `
          <div class="report-filters">
            <button class="chip" data-metodo="todos">Todos</button>
            <button class="chip" data-metodo="efectivo">Efectivo</button>
            <button class="chip" data-metodo="tarjeta">Tarjeta</button>
            <button class="chip" data-metodo="qr">QR</button>
          </div>`;
        header.insertAdjacentHTML('beforeend', filtrosHTML);
        header.querySelectorAll('.chip').forEach(btn => {
          btn.addEventListener('click', () => {
            filtroMetodo = btn.getAttribute('data-metodo') || 'todos';
            header.querySelectorAll('.chip').forEach(b => b.classList.toggle('active', b === btn));
            actualizarUIReporte();
          });
        });
        const def = header.querySelector('.chip[data-metodo="todos"]');
        if (def) def.classList.add('active');
      }
      // setInterval(checkResetReporte, 60000); // Eliminado
      loadDbInfo().then(checkConexion);
      setInterval(checkConexion, 20000);
      const usuarioId = localStorage.getItem('USUARIO_ID')
      if (!usuarioId) {
        mostrarLogin()
      } else {
        ocultarLogin()
      }
      actualizarUserBar()
      solicitarConsecutivo().catch(() => {})
      ;['click','keydown','mousemove','touchstart'].forEach(ev => {
        document.addEventListener(ev, resetInactividad)
      })
      resetInactividad()
    });
    function agregarVentaReporte(metodo) {
      // Ya no usamos localStorage local, recargamos desde BD
      setTimeout(() => {
        cargarReporte()
      }, 500)
    }
    const REPORTE_PASS = '79333587';
    function actualizarUIReporte() {
      const cont = document.getElementById('reporte-lista');
      const sumEl = document.getElementById('reporte-suma');
      if (!cont || !sumEl) return;
      const visibles = reporteVentas.filter(it => filtroMetodo === 'todos' ? true : it.m === filtroMetodo);
      cont.innerHTML = visibles.map((it, i) => `
        <div class="report-item">
          <span>#${it.id || '?'} ‚Äî ${formatearPesos(it.v)} ‚Äî ${(it.m || '').toUpperCase()}</span>
          <button class="report-del" onclick="eliminarVentaBD(${it.id})">Eliminar</button>
        </div>
      `).join('');
      const sumaTotal = reporteVentas.reduce((acc, it) => acc + (parseInt(it.v) || 0), 0);
      const sumaEf = reporteVentas.filter(it => it.m === 'efectivo').reduce((acc, it) => acc + it.v, 0);
      const sumaTa = reporteVentas.filter(it => it.m === 'tarjeta').reduce((acc, it) => acc + it.v, 0);
      const sumaQr = reporteVentas.filter(it => it.m === 'qr').reduce((acc, it) => acc + it.v, 0);
      sumEl.innerHTML = `
        <div><strong>Total vendido:</strong> ${formatearPesos(sumaTotal)}</div>
        <div><strong>Efectivo:</strong> ${formatearPesos(sumaEf)}</div>
        <div><strong>Tarjeta:</strong> ${formatearPesos(sumaTa)}</div>
        <div><strong>QR:</strong> ${formatearPesos(sumaQr)}</div>
      `;
    }
    function toggleReportePanel() {
      const p = document.getElementById('report-panel');
      if (!p) return;
      p.classList.toggle('open');
    }
    async function eliminarVentaBD(idConsecutivo) {
      const rol = localStorage.getItem('USUARIO_ROL')
      if (rol !== 'admin') {
        alert('Solo los usuarios administradores pueden eliminar ventas.')
        return
      }
      const confirmar = window.confirm('¬øEst√° seguro de eliminar la venta #' + idConsecutivo + '? Esta acci√≥n no se puede deshacer.')
      if (!confirmar) return

      try {
        const resp = await fetch(getApiBase() + '/api/venta/' + idConsecutivo, { method: 'DELETE' })
        if (resp.ok) {
          const data = await resp.json()
          if (data.ok) {
            alert('Venta eliminada correctamente')
            cargarReporte() // Recargar lista desde BD
            return
          }
        }
        alert('Error al eliminar la venta')
      } catch (e) {
        alert('Error de conexi√≥n al eliminar')
      }
    }
    function getSelectedMetodoPago() {
      const esEf = document.getElementById('pago-efectivo')?.checked;
      const esTa = document.getElementById('pago-tarjeta')?.checked;
      const esQr = document.getElementById('pago-qr')?.checked;
      if (esEf) return 'efectivo';
      if (esTa) return 'tarjeta';
      if (esQr) return 'qr';
      return null;
    }
    function obtenerTotalNumerico() {
      const totalText = document.getElementById('total-general')?.textContent || ''
      return parseInt(totalText.replace(/[^\d]/g, '')) || 0
    }
    function obtenerItemsBD() {
      const items = []
      tabla.querySelectorAll('tr').forEach(fila => {
        const cantTxt = fila.querySelector('.cant')?.innerText || ''
        const cant = parseInt(cantTxt.replace(/[^\d]/g, '')) || 0
        const desc = fila.cells[1]?.textContent.trim() || ''
        const vuTxt = fila.querySelector('.valor-u')?.innerText || ''
        const vu = parseInt(vuTxt.replace(/[^\d]/g, '')) || 0
        if (cant > 0 && desc) {
          items.push({
            descripcion: desc,
            cantidad: cant,
            valor_unitario: vu,
            valor_total: cant * vu
          })
        }
      })
      return items
    }
    async function buscarClientesRemoto(termino) {
      try {
        const url = getApiBase() + '/api/clientes?q=' + encodeURIComponent(termino)
        const resp = await fetch(url)
        if (!resp.ok) return []
        const data = await resp.json()
        const lista = Array.isArray(data?.clientes) ? data.clientes : []
        return lista.map(c => ({
          id: c.id,
          nombre: c.nombre,
          nit_cc: c.nit_cc,
          telefono: c.telefono,
          direccion: c.direccion,
        }))
      } catch {
        return []
      }
    }
    function renderDropdownClientes(clientes) {
      const dropdown = document.getElementById('autocomplete-dropdown')
      const input = document.getElementById('nombre-cliente')
      if (!dropdown) return
      dropdown.innerHTML = ''
      if (!clientes || clientes.length === 0) {
        dropdown.style.display = 'none'
        return
      }
      dropdown.style.display = 'block'
      if (input) {
        const rect = input.getBoundingClientRect()
        const offset = 12
        dropdown.style.position = 'fixed'
        dropdown.style.top = rect.bottom + 4 + 'px'
        dropdown.style.left = rect.left + offset + 'px'
        dropdown.style.right = ''
        dropdown.style.width = Math.max(rect.width - offset, 180) + 'px'
      } else {
        dropdown.style.position = 'absolute'
        dropdown.style.top = '100%'
        dropdown.style.left = '0'
        dropdown.style.right = '0'
        dropdown.style.width = '100%'
      }
      dropdown.style.background = '#ffffff'
      dropdown.style.border = '1px solid #d1d5db'
      dropdown.style.borderTop = 'none'
      dropdown.style.borderRadius = '0 0 4px 4px'
      dropdown.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1)'
      dropdown.style.zIndex = '9999'
      dropdown.style.maxHeight = '260px'
      dropdown.style.overflowY = 'auto'
      clientes.forEach(cliente => {
        const item = document.createElement('div')
        item.className = 'autocomplete-item'
        item.innerHTML = `
          <div class="cliente-nombre">ID: ${cliente.id} ¬∑ ${cliente.nombre}</div>
          <div class="cliente-info">NIT/CC: ${cliente.nit_cc || 'Sin NIT'}${cliente.telefono ? ' ¬∑ Tel: ' + cliente.telefono : ''}</div>
        `
        item.addEventListener('click', () => {
          seleccionarClienteAutocomplete(cliente)
        })
        dropdown.appendChild(item)
      })
    }
    function seleccionarClienteAutocomplete(cliente) {
      const input = document.getElementById('nombre-cliente')
      if (input) {
        input.value = `${cliente.id} - ${cliente.nit_cc || 'Sin NIT'} - ${cliente.nombre}`
      }
      clienteSeleccionado = cliente
      if (cliente && cliente.id) {
    localStorage.setItem('CLIENTE_ID', String(cliente.id))
  }

  // Si el formulario de transporte est√° activo, actualizar los datos
  if (document.getElementById('activar-transporte')?.checked) {
    document.getElementById('trans-nombre').value = cliente.nombre || '';
    document.getElementById('trans-direccion').value = cliente.direccion || '';
    document.getElementById('trans-telefono').value = cliente.telefono || '';
  }

  const dropdown = document.getElementById('autocomplete-dropdown')
      if (dropdown) {
        dropdown.style.display = 'none'
        dropdown.innerHTML = ''
      }
    }
    function inicializarAutocompletadoCliente() {
      const input = document.getElementById('nombre-cliente')
      const dropdown = document.getElementById('autocomplete-dropdown')
      if (!input || !dropdown) return
      input.addEventListener('input', () => {
        const term = input.value.trim()
        clienteSeleccionado = null
        localStorage.removeItem('CLIENTE_ID')
        if (clienteSearchTimer) {
          clearTimeout(clienteSearchTimer)
          clienteSearchTimer = null
        }
        if (term.length < 1) {
          dropdown.style.display = 'none'
          dropdown.innerHTML = ''
          return
        }
        clienteSearchTimer = setTimeout(async () => {
          const clientes = await buscarClientesRemoto(term)
          renderDropdownClientes(clientes)
        }, 250)
      })
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.cliente-container')) {
          dropdown.style.display = 'none'
          dropdown.innerHTML = ''
        }
      })
    }
    function getPuntoVenta() {
      const select = document.getElementById('select-punto-venta');
      if (select) return select.value;
      const esBodega = document.body.classList.contains('formato-bodega') || document.getElementById('contenido-factura')?.classList.contains('formato-bodega')
      return esBodega ? 'bodega' : 'ferreteria'
    }
    function actualizarPuntoVenta(valor) {
      const body = document.body;
      const contenido = document.getElementById('contenido-factura');
      if (valor === 'bodega') {
        body.classList.add('formato-bodega');
        if (contenido) contenido.classList.add('formato-bodega');
      } else {
        body.classList.remove('formato-bodega');
        if (contenido) contenido.classList.remove('formato-bodega');
      }
    }
    
    function getTipoPago() {
      const select = document.getElementById('select-tipo-pago')
      const val = select ? select.value : 'CONTADO'
      return val === 'CREDITO' ? 'CREDITO' : 'CONTADO'
    }
    function getIds() {
      const u = parseInt(localStorage.getItem('USUARIO_ID') || '1') || 1
      const c = parseInt(localStorage.getItem('CLIENTE_ID') || '1') || 1
      return { usuario_id: u, cliente_id: c }
    }
    let lastConsecutivo = null
    let clienteSeleccionado = null
    let clienteSearchTimer = null
    async function solicitarConsecutivo() {
      const resp = await fetch(getApiBase() + '/api/consecutivo', { method: 'POST' })
      if (!resp.ok) throw new Error('no consecutivo')
      const data = await resp.json()
      const numero = data && (data.id_consecutivo ?? data.consecutivo ?? data.numero)
      if (!numero) throw new Error('respuesta sin consecutivo')
      lastConsecutivo = numero
      const el = document.getElementById('numero-consecutivo')
      if (el) el.textContent = numero
      return numero
    }
    async function guardarVentaBD(metodo) {
      const items = obtenerItemsBD()
      if (items.length === 0) return false
      const total = obtenerTotalNumerico()
      const clienteTexto = document.getElementById('nombre-cliente')?.value.trim() || ''
      const tipo_pago = getTipoPago()
      const { usuario_id, cliente_id } = getIds()
      if (tipo_pago === 'CREDITO') {
        if (!clienteSeleccionado || !clienteSeleccionado.id) {
          alert('No se puede financiar facturas a clientes no registrados en la base de datos')
          return false
        }
      }
      const id_consecutivo = await solicitarConsecutivo()
      lastConsecutivo = id_consecutivo
      const payload = {
        id_consecutivo,
        usuario_id,
        cliente_id,
        total,
        tipo_pago,
        forma_pago: (metodo || '').toUpperCase(),
        punto_venta: getPuntoVenta(),
        items,
        cliente_nombre: clienteTexto
      }
      const resp = await fetch(getApiBase() + '/api/venta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      if (!resp.ok) return false
      const data = await resp.json()
      return !!data?.ok
    }
// Seleccionar todo el contenido de la celda activa al presionar Shift
tabla.addEventListener('keydown', (e) => {
  if (e.key === 'Shift' && celdaActiva) {
    const range = document.createRange();
    range.selectNodeContents(celdaActiva);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }
});
// Actualizar la fecha y hora actual en el div
function actualizarFechaHora() {
  const ahora = new Date();
  const opciones = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
  const fechaFormateada = ahora.toLocaleString('es-CO', opciones).replace('.', '');
  document.getElementById('fecha-actual').innerHTML = `<strong>FECHA:</strong> ${fechaFormateada}`;
}

// Llamar la funci√≥n al cargar la p√°gina
actualizarFechaHora();


  </script>
  </body>
</html>
